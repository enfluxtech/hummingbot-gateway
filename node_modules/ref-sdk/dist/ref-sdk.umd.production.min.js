!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("near-api-js"),require("bn.js"),require("mathjs"),require("big.js"),require("lodash-es")):"function"==typeof define&&define.amd?define(["exports","near-api-js","bn.js","mathjs","big.js","lodash-es"],t):t((e=e||self)["ref-sdk"]={},e.nearApiJs,e.BN,e.math,e.Big,e._)}(this,(function(e,t,n,r,o,u){"use strict";function i(e){switch(void 0===e&&(e=process.env.NEAR_ENV),e){case"mainnet":return{networkId:"mainnet",nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.near.org",WRAP_NEAR_CONTRACT_ID:"wrap.near",REF_FI_CONTRACT_ID:"v2.ref-finance.near"};case"testnet":return{networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",walletUrl:"https://wallet.testnet.near.org",WRAP_NEAR_CONTRACT_ID:"wrap.testnet",REF_FI_CONTRACT_ID:"ref-finance-101.testnet"};default:return{networkId:"mainnet",nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.near.org",REF_FI_CONTRACT_ID:"v2.ref-finance.near",WRAP_NEAR_CONTRACT_ID:"wrap.near"}}}n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n,o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o,u=u&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u;var a=i(),s=a.REF_FI_CONTRACT_ID,c=function(e){return new Error(e)},l=c("Something wrong happened"),p=c("Input token should be different with output token"),f=c("Input amount should be greater than 0"),d=c("No pool found for the input tokens"),v=c("Please login in first"),h=c("Something wrong happened, we don't get correct routes corrreponding to current input"),m=c("This token doesn't exist in "+i().networkId),k=function(e,t){return{id:Number(t&&t>=0?t:e.id),tokenIds:e.token_account_ids,supplies:e.amounts.reduce((function(t,n,r){return t[e.token_account_ids[r]]=n,t}),{}),fee:e.total_fee,shareSupply:e.shares_total_supply,tvl:e.tvl,token0_ref_price:e.token0_ref_price,pool_kind:e.pool_kind}},w=function(e){return{id:e.id,token1Id:e.tokenIds[0],token2Id:e.tokenIds[1],token1Supply:e.supplies[e.tokenIds[0]],token2Supply:e.supplies[e.tokenIds[1]],fee:e.fee,shares:e.shareSupply,token0_price:e.token0_ref_price||"0"}},g=function(e,t){return e.map((function(e){return e.token_account_ids})).flat().includes(t.toString())},y=function(e,t){return e.map((function(e){return e.id.toString()})).includes(t.toString())},b=function(e){return"RATED_SWAP"===e.pool_kind?24:18},I=function(e,t){return Number.isInteger(Number(t))?t:Math.ceil(Math.round(Number(t)*Math.pow(10,e))/Math.pow(10,e)).toString()},_=function(e){return r.divide(e,100)},x=function(e,t){return r.evaluate(_(e)+" * "+t)},S=function(e,t){return r.format(r.evaluate(t+" - "+x(e,t)),{notation:"fixed"})},O=/^0*\.?0*$/,N=function(e,t){return void 0===t&&(t="0"),e?((t.substring(0,t.length-e)||"0")+"."+t.substring(t.length-e).padStart(e,"0").substring(0,e)).replace(/\.?0+$/,""):t},T=function(e,t){if(null==e)return t;var n=t.split("."),r=n[1];return(""+n[0]+(void 0===r?"":r).padEnd(e,"0").slice(0,e)).replace(/^0+/,"").padStart(1,"0")},P=function(e){var t,n;if(!/e/.test(e)||!e)return e;var r=!0;/e-/.test(e)&&(r=!1);var o=Number(e)<0?"-":"",u=Number(null==(t=e.match(/\d+$/))?void 0:t[0]),i=null==(n=e.match(/[\d\.]+/))?void 0:n[0];if(!u||!i)return e;var a,s,c=i.includes(".");return c?(a=i.split(".")[0],s=i.split(".")[1]):(a=i,s=""),r?c?s.length<=u?o+a+s.padEnd(u,"0"):o+a+s.substring(0,u)+"."+s.substring(u):o+a.padEnd(u+a.length,"0"):c?o+a.padStart(u+a.length,"0").replace(/^0/,"0.")+s:o+a.padStart(u+a.length,"0").replace(/^0/,"0.")},E=function(e){for(var t=/(-?\d+)(\d{3})/;t.test(e);)e=e.replace(t,"$1,$2");return e},A=function(e,t,n,r){void 0===n&&(n=!1),void 0===r&&(r=!0);var o=e.split("."),u=o[0],i=o[1],a=void 0===i?"":i,s=((n?E(u):u)+"."+a.slice(0,t)).replace(/\.$/,"");if(r&&0===Number(s)&&s.length>1){var c=s.lastIndexOf("0");s=s.slice(0,c)+s.slice(c).replace("0","1")}return s};function R(){R=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",u=r.asyncIterator||"@@asyncIterator",i=r.toStringTag||"@@toStringTag";function a(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,n){return e[t]=n}}function s(e,t,n,r){var o=Object.create((t&&t.prototype instanceof p?t:p).prototype),u=new _(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(o,u){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw u;return{value:void 0,done:!0}}for(n.method=o,n.arg=u;;){var i=n.delegate;if(i){var a=y(i,n);if(a){if(a===l)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=c(e,t,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===l)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}(e,n,u),o}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=s;var l={};function p(){}function f(){}function d(){}var v={};a(v,o,(function(){return this}));var h=Object.getPrototypeOf,m=h&&h(h(x([])));m&&m!==t&&n.call(m,o)&&(v=m);var k=d.prototype=p.prototype=Object.create(v);function w(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function g(e,t){var r;this._invoke=function(o,u){function i(){return new t((function(r,i){!function r(o,u,i,a){var s=c(e[o],e,u);if("throw"!==s.type){var l=s.arg,p=l.value;return p&&"object"==typeof p&&n.call(p,"__await")?t.resolve(p.__await).then((function(e){r("next",e,i,a)}),(function(e){r("throw",e,i,a)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,a)}))}a(s.arg)}(o,u,r,i)}))}return r=r?r.then(i,i):i()}}function y(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,y(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=c(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var o=r.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function x(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,u=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return u.next=u}}return{next:S}}function S(){return{value:void 0,done:!0}}return f.prototype=d,a(k,"constructor",d),a(d,"constructor",f),f.displayName=a(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,i,"GeneratorFunction")),e.prototype=Object.create(k),e},e.awrap=function(e){return{__await:e}},w(g.prototype),a(g.prototype,u,(function(){return this})),e.AsyncIterator=g,e.async=function(t,n,r,o,u){void 0===u&&(u=Promise);var i=new g(s(t,n,r,o),u);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(k),a(k,i,"Generator"),a(k,o,(function(){return this})),a(k,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=x,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(I),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var u=this.tryEntries[o],i=u.completion;if("root"===u.tryLoc)return r("end");if(u.tryLoc<=this.prev){var a=n.call(u,"catchLoc"),s=n.call(u,"finallyLoc");if(a&&s){if(this.prev<u.catchLoc)return r(u.catchLoc,!0);if(this.prev<u.finallyLoc)return r(u.finallyLoc)}else if(a){if(this.prev<u.catchLoc)return r(u.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<u.finallyLoc)return r(u.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var u=o;break}}u&&("break"===e||"continue"===e)&&u.tryLoc<=t&&t<=u.finallyLoc&&(u=null);var i=u?u.completion:{};return i.type=e,i.arg=t,u?(this.method="next",this.next=u.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),I(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;I(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:x(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}function j(e,t,n,r,o,u,i){try{var a=e[u](i),s=a.value}catch(e){return void n(e)}a.done?t(s):Promise.resolve(s).then(r,o)}function L(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var u=e.apply(t,n);function i(e){j(u,r,o,i,a,"next",e)}function a(e){j(u,r,o,i,a,"throw",e)}i(void 0)}))}}function D(){return(D=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function M(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return F(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?F(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var C=function(){var e=L(R().mark((function e(t){var n,r,o,u,i,a,c,l,p,f,d;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.tokenIn,o=t.tokenOut,u=t.amountIn,i=t.slippageTolerance,c=[],(null==(n=(a=t.swapTodos).at(-1))?void 0:n.outputToken)===o.id){e.next=4;break}throw h;case 4:for(f in l=[],p=a.map((function(e){return[e.inputToken,e.outputToken]})))l.push((d=p[f])[0]===r.id&&d[1]===o.id?{pool_id:a[f].pool.id,token_in:r.id,token_out:o.id,amount_in:a[f].pool.partialAmountIn,min_amount_out:I(o.decimals,T(o.decimals,S(i,a[f].estimate)))}:d[0]===r.id?{pool_id:a[f].pool.id,token_in:d[0],token_out:d[1],amount_in:a[f].pool.partialAmountIn,min_amount_out:"0"}:{pool_id:a[f].pool.id,token_in:d[0],token_out:d[1],min_amount_out:I(o.decimals,T(o.decimals,S(i,a[f].estimate)))});return c.push({receiverId:r.id,functionCalls:[{methodName:"ft_transfer_call",args:{receiver_id:s,amount:T(r.decimals,u),msg:JSON.stringify({force:0,actions:l})},gas:"180000000000000",amount:"0.000000000000000000000001"}]}),e.abrupt("return",c);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),B=new t.keyStores.BrowserLocalStorageKeyStore,G=new t.Near(D({keyStore:B,headers:{}},a)),W=new t.WalletConnection(G,s),J=function(e){var t=e.methodName,n=e.args;return W.account().viewFunction(s,t,n)},U=function(e,t){var n=t.methodName,r=t.args;return W.account().viewFunction(e,n,r)},q=function(){var e=L(R().mark((function e(){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",J({methodName:"get_number_of_pools"}));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),$=function(){var e=L(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(t,{methodName:"ft_metadata"}).catch((function(){throw m}));case 2:return e.abrupt("return",D({},e.sent,{id:t}));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),K=function(){var e=L(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(t.map((function(e){return $(e)})));case 2:return e.abrupt("return",e.sent.reduce((function(e,n,r){var o;return D({},e,((o={})[t[r]]=n,o))}),{}));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),V=function(){var e=L(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.id,e.abrupt("return",J({methodName:"get_rated_pool",args:{pool_id:Number(n)}}).then((function(e){return D({},e,{id:Number(n),pool_kind:"RATED_SWAP"})})).catch((function(){throw l})));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Y=function(){var e=L(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.id,e.abrupt("return",J({methodName:"get_stable_pool",args:{pool_id:Number(n)}}).then((function(e){return D({},e,{id:Number(n),pool_kind:"STABLE_SWAP",rates:e.c_amounts.map((function(e){return T(18,"1")}))})})).catch((function(){throw l})));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),H=function(){var e=L(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all(t.map((function(e){return"RATED_SWAP"===e.pool_kind?V({id:e.id}):Y({id:e.id})}))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Z=function(){var e=L(R().mark((function e(t,n){var r;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=1),void 0===n&&(n=100),r=(t-1)*n,e.next=5,J({methodName:"get_pools",args:{from_index:r,limit:n}});case 5:return e.abrupt("return",e.sent.map((function(e,t){return k(e,t+r)})));case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),z=function(){var e=L(R().mark((function e(){var t,n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,q();case 2:return t=Math.ceil(e.sent/100),e.next=6,Promise.all([].concat(Array(t)).map((function(e,t){return Z(t+1)})));case 6:return n=e.sent.flat(),e.abrupt("return",{simplePools:n.filter((function(e){return e.pool_kind&&"SIMPLE_POOL"===e.pool_kind})),unRatedPools:n.filter((function(e){return e.pool_kind&&"STABLE_SWAP"===e.pool_kind})),ratedPools:n.filter((function(e){return e.pool_kind&&"RATED_SWAP"===e.pool_kind}))});case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Q=function(e,t){for(var n=t.length,r=u.sum(t),o=0,i=r,a=0;a<256;a++){for(var s,c=i,l=M(t);!(s=l()).done;)c=c*i/(s.value*n);o=i;var p=e*Math.pow(n,n);if(i=o*(c*n+p*r)/(o*(p-1)+c*(n+1)),Math.abs(i-o)<=1)break}return i},X=function(e,t,n,r,o){for(var u=n.length,i=e*Math.pow(u,u),a=Q(e,n),s=t,c=a*a/t,l=0;l<u;l++)l!=r&&l!=o&&(s+=n[l],c=c*a/n[l]);c=c*a/(i*Math.pow(u,u));for(var p=a/i+s,f=0,d=a,v=0;v<256&&(f=d,d=(Math.pow(d,2)+c)/(2*d+p-a),!(Math.abs(d-f)<=1));v++);return d},ee=function(e,t,n,r,o,u){var i=X(e,n+o[t],o,t,r),a=o[r]-i,s=function(e,t){return e*t/1e4}(a,u);return[a-s,s,a]},te=function(e,t,n,r,u){var i=r.amp,a=r.total_fee,s=r.token_account_ids.findIndex((function(t){return t===e})),c=r.token_account_ids.findIndex((function(e){return e===t})),l=r.rates.map((function(e){return N(u,e)})),p=r.c_amounts.map((function(e){return N(u,e)})).map((function(e,t){return T(u,P(new o(e||0).times(new o(l[t])).toString()))})).map((function(e){return Number(e)})),f=Number(T(u,P(new o(n).times(new o(l[s])).toString()))),d=ee(i,s,f,c,p,a),v=d[1],h=d[2];return[d[0]/Number(l[c]),v,h/Number(l[c])]};function ne(e,t){t=new o(t);for(var n=(e=e.map((function(e){return new o(e).round()}))).map((function(e){return new o(e)})).reduce((function(e,t){return e.plus(t)}),new o(0)),r=t.minus(n),u=new o(0),i=0,a=0;a<e.length;a++)e[a].gt(u)&&(i=a,u=e[a]);for(var s=[],c=0;c<e.length;c++)s.push(c===i?e[c].plus(r).toString():e[c].toString());return s}o.RM=0,o.DP=40,o.NE=-40,o.PE=40;var re=R().mark(je);function oe(e){if(e<BigInt(0))throw"square root of negative numbers is not supported";return e<BigInt(2)?e:function e(t,n){var r=t/n+n>>BigInt(1);return n===r||n===r-BigInt(1)?n:e(t,r)}(e,BigInt(1))}function ue(e,t){if(e.length||(e=[e]),1==e.length)var n=new o(e[0].reserves[t[0]]);else if(2==e.length){var r=e[1];n=new o(e[0].reserves[t[0]]).times(new o(r.reserves[t[1]]))}return n}function ie(e,t){if(e.length||(e=[e]),1==e.length)var n=e[0],r=new o(1e4).minus(new o(n.fee)).div(new o(1e4)),u=o(r);else if(2==e.length){var i=e[0],a=e[1],s=new o(1e4).minus(new o(i.fee)).div(new o(1e4)),c=new o(1e4).minus(new o(a.fee)).div(o(1e4));u=new o(a.reserves[t[1]]).times(new o(s)).plus(new o(i.reserves[t[1]]).times(s).times(c))}return u}function ae(e,t){if(e.length||(e=[e]),1==e.length){var n,r=e[0],u=t[0],i=t[1],a=new o(1e4).minus(new o(r.fee)).div(new o(1e4)),s=r.token2Id,c=r.token2Supply;r.reserves=((n={})[r.token1Id]=r.token1Supply,n[s]=c,n);var l=new o(r.reserves[u]).times(new o(r.reserves[i]).times(new o(a)))}else if(2==e.length){var p,f,d=e[0],v=e[1],h=d.token2Id,m=d.token2Supply;d.reserves=((p={})[d.token1Id]=d.token1Supply,p[h]=m,p);var k=v.token2Id,w=v.token2Supply;v.reserves=((f={})[v.token1Id]=v.token1Supply,f[k]=w,f);var g=t[0],y=t[1],b=t[2],I=new o(1e4).minus(o(d.fee)).div(new o(1e4)),_=new o(1e4).minus(new o(v.fee)).div(new o(1e4)),x=new o(d.reserves[g]).times(new o(d.reserves[y])).times(I),S=new o(v.reserves[y]).times(new o(v.reserves[b])).times(_);l=x.times(S)}return l}function se(e,t,n){var r=ae(t,n),u=ue(t,n),i=ie(t,n);return new o(e).abs().times(new o(oe(BigInt(new o(r).round().toFixed())))).minus(u).div(i)}function ce(e,t){var n=[];for(var r in t){var o=t[r].map((function(e){return e.length})).reduce((function(e,t){return e*t}),1);n.push(o)}var u=[];for(var i in e)for(var a=e[i],s=n[i],c=0;c<s;c++)u.push(a);return u}function le(e,t,n){void 0===n&&(n=.001);var r=[];for(var o in e){for(var u=e[o],i=[],a=[],s=0;s<u.length-1;s++)a.push([u[s],u[s+1]]);for(var c in a){var l=a[c],p=xe(t,l[0],l[1]);i.push(p)}r.push(i)}return function(e,t){void 0===t&&(t=.001);var n=[];for(var r in e){var o=e[r],u=[];for(var i in o){var a=Se(o[i],t);u.push(a)}n.push(u)}return n}(r,n)}function pe(e){var t=[];for(var n in e){var r=e[n].reduce((function(e,t){return e.flatMap((function(e){return t.map((function(t){return[e,t].flat()}))}))}));t.push.apply(t,r)}for(var o in t)t[o].length||(t[o]=[t[o]]);return t}function fe(e,t,n,r){if(r=new o(r),t===e.token1Id&&n===e.token2Id)var u,i=((u={})[t]=new o(e.token1Supply),u[n]=new o(e.token2Supply),u);else{if(t!==e.token2Id||n!==e.token1Id)return new o(0);var a;(a={})[n]=new o(e.token1Supply),a[t]=new o(e.token2Supply),i=a}var s=new o(1e4).minus(new o(e.fee)).div(new o(1e4)),c=r.times(s).times(i[n]),l=i[t].plus(s.times(r));return c.div(l)}function de(e,t,n){if(new o(n).eq(new o(0)))return new o(0);if(n=new o(n),e.length||(e=[e]),1==e.length)var r=fe(e[0],t[0],t[1],n);else 2==e.length&&(r=function(e,t,n,r,u){for(var i in u=new o(u),e){var a=e[i];a.gamma=new o(1e4).minus(new o(a.fee)).div(new o(1e4))}var s,c,l=e[0],p=e[1];if(t===l.token1Id&&n===l.token2Id)l.reserves=((s={})[t]=new o(l.token1Supply),s[n]=new o(l.token2Supply),s);else if(n===l.token1Id&&t===l.token2Id){var f;l.reserves=((f={})[n]=new o(l.token1Supply),f[t]=new o(l.token2Supply),f)}if(n===p.token1Id&&r===p.token2Id)p.reserves=((c={})[n]=new o(p.token1Supply),c[r]=new o(p.token2Supply),c);else if(r===p.token1Id&&n===p.token2Id){var d;p.reserves=((d={})[r]=new o(p.token1Supply),d[n]=new o(p.token2Supply),d)}var v=new o(l.reserves[n]),h=new o(l.reserves[t]),m=new o(p.reserves[n]),k=new o(p.reserves[r]),w=l.gamma,g=p.gamma,y=u.times(v).times(k).times(w).times(g),b=m.times(h).plus(u.times(m.times(w).plus(v.times(w).times(g))));return y.div(b)}(e,t[0],t[1],t[2],n));return r}function ve(e,t,n){var r=function e(t,n,r){var u=function(e,t,n){var r=[];for(var o in t)r.push(se(e,t[o],n[o]));return r}(function(e,t,n){var r=function(e,t){var n=new o(0);for(var r in e){var u=e[r],i=t[r],a=ae(u,i),s=new o(oe(BigInt(new o(a).round().toFixed()))),c=ie(u,i),l=new o(c);n=n.plus(s.div(l))}return n}(e,t),u=function(e,t){var n=new o(0);for(var r in e){var u=e[r],i=t[r],a=new o(ue(u,i)),s=new o(ie(u,i));n=n.plus(a.div(s))}return n}(e,t);return new o(n).plus(u).div(r)}(t,n,r=new o(r)),t,n);u.every((function(e){return e.lt(new o(0))}))&&(u=u.map((function(e){return e.times(new o(-1))}))),u.some((function(e){return e.lt(new o(0))}))&&(u=function(t,n,r,u){u=new o(u);var i=[];for(var a in r)r[a].gt(new o(0))&&i.push(a);var s=[],c=[];for(var a in i){var l=i[a];s.push(t[l]),c.push(n[l])}r=e(s,c,u);var p={};for(var a in i)p[i[a]]=r[a];var f=[];for(var a in t)if(i.includes(a))f.push(p[a]);else{var d=new o(0);f.push(d)}return f}(t,n,u,r));var i=u.reduce((function(e,t){return e.plus(t)}),new o(0));return u.map((function(e){return e.div(i).times(new o(r))}))}(e,t,n),u=[];for(var i in e){var a=de(e[i],t[i],r[i]);u.push(a)}return{result:u,allocations:r}}function he(e,t,n){var r=ve(e,t,n),u=r.result,i=r.allocations;return i=ne(i,n),new o(0),new o(0),{input:i,output:u.map((function(e){return new o(e)})).reduce((function(e,t){return e.plus(t)}),new o(0))}}function me(e,t,n,r,o,u){return ke.apply(this,arguments)}function ke(){return(ke=L(R().mark((function e(t,n,r,u,i,a){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===i&&(i=3),void 0===a&&(a=.001),e.abrupt("return",function(){var e=L(R().mark((function e(u){var s,c,l,p,f;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=new o(u),e.next=3,De(t,n,r,i);case 3:if((s=e.sent).length){e.next=6;break}return e.abrupt("return",{allocations:[],outputs:new o(0),routes:[],nodeRoutes:[]});case 6:return e.next=8,le(s,t,a);case 8:return c=e.sent,e.next=11,pe(c);case 11:return l=e.sent,e.next=14,ce(s,c);case 14:return p=e.sent,e.next=17,he(l,p,u);case 17:return e.abrupt("return",{allocations:(f=e.sent).input,outputs:f.output,routes:l,nodeRoutes:p});case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(u));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function we(e,t,n){return function(e,t,n){var r=n.map((function(e){return new o(e)})).reduce((function(e,t){return e.plus(t)}),new o(0)).toString(),u=[];for(var i in e){var a=e[i],s=t[i],c=n[i];if(!new o(c).eq(new o(0))&&(a.length||(a=[a]),a[0]))for(var l in a){var p=a[l];if(0==l){var f={pool:p,allocation:c.toString(),inputToken:s[0],outputToken:s[1],nodeRoute:s,route:a,allRoutes:e,allNodeRoutes:t,totalInputAmount:r,allAllocations:n};if(u.push(f),s.length>2)var d=fe(p,s[0],s[1],c)}else f={pool:p,allocation:d.toString(),inputToken:s[1],outputToken:s[2],nodeRoute:s,route:a,allRoutes:e,allNodeRoutes:t,totalInputAmount:r,allAllocations:n},u.push(f)}}return u}(e,t,n)}function ge(e,t,n,r,o,u,i,a,s){return ye.apply(this,arguments)}function ye(){return(ye=L(R().mark((function e(t,n,r,u,i,a,s,c,l){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===i&&(i=3),void 0===a&&(a=.001),void 0===s&&(s=2),void 0===c&&(c=4),void 0===l&&(l=[]),e.abrupt("return",function(){var e=L(R().mark((function e(u){var p,f,d,v,h,m,k,w,g,y,b,I,_,x,S,O,N,T,P,E,A,j,D,F,C,B,G,W,J,U,q,K,V,Y,H,Z,z,Q,X,ee,te,re,oe,ue,ie,ae,se,ce,le,pe,de,he,ke,ye,Ie,xe,Se,Oe,Ne,Te,Pe,Ee,Ae,Re,je,Le,De,Fe,Me,Ce,Be,Ge,We,Je,Ue;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u){e.next=2;break}return e.abrupt("return",[]);case 2:return u=new o(u),t=t.filter((function(e){return!l.includes(e.id)})),e.next=6,me(t,n,r,u,i,a);case 6:for(d=(p=e.sent).routes,v=p.nodeRoutes,h=_e(f=p.allocations),m=h.slice(0,10),k=[],w=[],g=M(m);!(y=g()).done;)k.push(d[b=y.value]),w.push(v[b]);for(T in d=k,v=w,I=new o(0),_=p.allocations,x=p.nodeRoutes,O=[],N=[],S=p.routes)2==(P=x[T]).length&&(O.push(P),N.push(S[T]));if(E=!1,O.length>0){if(A=ve(N,O,u),D=A.result,(j=A.allocations).length>c){for(G in F=(F=_e(j)).slice(0,c),C=[],B=[],F)C.push(N[F[G]]),B.push(O[F[G]]);A=ve(C,B,u),j=A.allocations,D=A.result}W=D.reduce((function(e,t){return e.plus(t)}),new o(0)),new o(W).gt(I)&&(_=j,I=W,S=N,x=O,E=!0)}J=!1,e.t0=R().keys(d);case 29:if((e.t1=e.t0()).done){e.next=59;break}G=e.t1.value,e.t2=R().keys(d);case 32:if((e.t3=e.t2()).done){e.next=57;break}if(!((U=e.t3.value)>G)){e.next=55;break}for(q=d[G],K=d[U],V=v[G],Y=v[U],H=new Set(q.map((function(e){return e.id}))),Z=new Set(K.map((function(e){return e.id}))),z=!1,Q=M(H);!(X=Q()).done;)Z.has(X.value)&&(z=!0);if(!z){e.next=47;break}return e.abrupt("continue",32);case 47:J=!0,re=ve(ee=[q,K],te=[V,Y],u),oe=re.allocations,ue=re.result.reduce((function(e,t){return e.plus(t)}),new o(0)),new o(ue).gt(I)&&(_=oe,I=ue,S=ee,x=te,E=!1);case 55:e.next=32;break;case 57:e.next=29;break;case 59:if(!J)for(G in d)se=ve(ie=[d[G]],ae=[v[G]],u),ce=se.allocations,le=se.result.reduce((function(e,t){return e.plus(t)}),new o(0)),new o(le).gt(I)&&(_=ce,I=le,S=ie,x=ae,E=!1);if(f=_,v=x,!((d=S).length<1)){e.next=65;break}return e.abrupt("return",[]);case 65:for(G in pe=_e(f.map((function(e){return new o(e)}))),E&&(s=4),de=pe.slice(0,s),he=[],ke=[],de)he.push(d[ye=de[G]]),ke.push(v[ye]);for(G in he)he[G].length||(he[G]=[he[G]]);if(Ie=he[0].map((function(e){return e.id})),!(he.length>1)){e.next=84;break}xe=he[1].map((function(e){return e.id})),Se=!1,e.t4=R().keys(xe);case 77:if((e.t5=e.t4()).done){e.next=84;break}if(!Ie.includes(xe[G=e.t5.value])){e.next=82;break}return Se=!0,e.abrupt("break",84);case 82:e.next=77;break;case 84:if(!Se){e.next=109;break}for(G in Oe=[],Ne=[],pe)Oe.push(d[pe[G]]),Ne.push(v[pe[G]]);for(G in Te=Oe[0].map((function(e){return e.id})),Oe)Oe[G].length||(Oe[G]=[Oe[G]]);Pe=Oe.map((function(e){return e.map((function(e){return e.id}))})),e.t6=R().keys(Pe);case 93:if((e.t7=e.t6()).done){e.next=109;break}G=e.t7.value,e.t8=R().keys(Pe[G]);case 96:if((e.t9=e.t8()).done){e.next=107;break}if(!Te.includes(Pe[G][U=e.t9.value])){e.next=100;break}return e.abrupt("break",107);case 100:return(Ee=Oe[G]).length||(Ee=[Ee]),he=[Oe[0],Ee],ke=[Ne[0],Ne[G]],e.abrupt("break",107);case 107:e.next=93;break;case 109:Ae=ve(he,ke,u),Re=ne(Re=Ae.allocations,u).map((function(e){return new o(e)})),je=we(he,ke,Re),Le=[],e.t10=R().keys(je);case 116:if((e.t11=e.t10()).done){e.next=139;break}return G=e.t11.value,e.next=120,$(je[G].inputToken);case 120:return Fe=e.sent,e.next=123,$(je[G].outputToken);case 123:if(Me=e.sent.decimals,Ce=fe(je[G].pool,je[G].inputToken,je[G].outputToken,je[G].allocation),Be=new o(Ce).div(new o(10).pow(Me)).toString(),!new o(Ce).lt(new o(1))){e.next=130;break}return l.push(je[G].pool.id),e.abrupt("return",ge(t,n,r,u,i=i,a=a,s=s,c=c,l=l));case 130:return Ge=je[G].inputToken==n&&je[G].outputToken==r?"parallel swap":"stableSmart",e.next=133,Promise.all(je[G].nodeRoute.map(function(){var e=L(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,$(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 133:We=e.sent,Le[G]={estimate:Be,pool:{fee:je[G].pool.fee,gamma_bps:new o(1e4).minus(new o(je[G].pool.fee)),id:je[G].pool.id,partialAmountIn:new o(je[G].allocation).round().toString(),supplies:(De={},De[je[G].pool.token1Id]=je[G].pool.token1Supply,De[je[G].pool.token2Id]=je[G].pool.token2Supply,De),token0_ref_price:je[G].pool.token0_price,tokenIds:[je[G].pool.token1Id,je[G].pool.token2Id],Dex:je[G].pool.Dex},status:Ge,token:Fe,outputToken:je[G].outputToken,inputToken:je[G].inputToken,nodeRoute:je[G].nodeRoute,route:je[G].route,allRoutes:je[G].allRoutes,allNodeRoutes:je[G].allNodeRoutes,totalInputAmount:je[G].totalInputAmount,allAllocations:je[G].allAllocations,tokens:We,routeInputToken:n,routeOutputToken:r,overallPriceImpact:"0"},Le[G].pool.x=Le[G].pool.supplies[je[G].inputToken],Le[G].pool.y=Le[G].pool.supplies[je[G].outputToken],e.next=116;break;case 139:return e.next=141,be(Le);case 141:for(G in Je=e.sent,Le)(Ue=Le[G]).overallPriceImpact=Je,Ue.outputToken===r&&Ue.inputToken!=n&&(Ue.pool.partialAmountIn="0");return e.abrupt("return",Le);case 144:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(u));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function be(e){return Ie.apply(this,arguments)}function Ie(){return(Ie=L(R().mark((function e(t){var n,r,u,i,a,s,c,l,p,f,d,v,h,m,k,w,g,y,b,I,_,x,S;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.filter((function(e){return e.outputToken==e.routeOutputToken})).map((function(e){return new o(e.estimate)})).reduce((function(e,t){return e.plus(t)}),new o(0)),r=t[0].tokens[0],u=new o(t[0].totalInputAmount).div(new o(10).pow(r.decimals)),i=n.div(u),a=new o(0),s=t[0].allRoutes,c=t[0].allNodeRoutes,l=t[0].allAllocations.map((function(e){return new o(e)})),p=l.map((function(e){return new o(e)})).reduce((function(e,t){return e.plus(t)}),new o(0)),f=l.map((function(e){return e.div(p)})),e.t0=R().keys(s);case 11:if((e.t1=e.t0()).done){e.next=23;break}return v=s[d=e.t1.value],h=c[d],e.next=17,Promise.all(h.map(function(){var e=L(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,$(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 17:m=e.sent,k=f[d],1==v.length?(w=new o(v[0].reserves[h[0]]).div(new o(10).pow(m[0].decimals)),g=new o(v[0].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),y=w.div(g)):(b=new o(v[0].reserves[h[0]]).div(new o(10).pow(m[0].decimals)),I=new o(v[0].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),_=new o(v[1].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),x=new o(v[1].reserves[h[2]]).div(new o(10).pow(m[2].decimals)),y=b.div(I).times(_).div(x)),a=a.plus(k.times(new o(1).div(y))),e.next=11;break;case 23:return S=a.minus(i).div(i).times(new o(100)).toString(),e.abrupt("return",S);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _e(e){return function(e){var t=[];for(var n in e)t.push([e[n],n]);return t}(e).sort((function(e,t){return new o(t[0]).minus(new o(e[0]))})).map((function(e){return e[1]}))}function xe(e,t,n,r){void 0===r&&(r=!0);var o=e.filter((function(e){return e.token1Id===t&&e.token2Id===n||e.token1Id===n&&e.token2Id===t}));return r&&(o=o.filter((function(e){return"0"!=e.token1Supply&&"0"!=e.token2Supply}))),o}function Se(e,t){void 0===t&&(t=1e-4);for(var n=new o(t),r=function(e){var t=function(e){var t=[];for(var n in e){var r=e[n];r.amounts=[r.token1Supply,r.token2Supply];var u=r.amounts.map((function(e){return new o(e)})),i=u[0].times(u[1]);t.push(i)}return t}(e),n=function(e){if(e.length<1)return null;var t=e[0];for(var n in e){var r=e[n];r.gt(t)&&(t=r)}return t}(t);return t.map((function(e){return e.div(n)}))}(e),u=[],i=0;i<r.length;i++)r[i]>n&&u.push(e[i]);return u}function Oe(e,t){var n=t[0],r=t[1];Object.keys(e).includes(n)?Object.keys(e[n]).includes(r)||(e[n][r]=1):(e[n]={},e[n][r]=1),Object.keys(e).includes(r)?Object.keys(e[r]).includes(n)||(e[r][n]=1):(e[r]={},e[r][n]=1)}function Ne(e,t){var n=JSON.parse(JSON.stringify(e)),r=t[0],o=t[1];return Object.keys(n).includes(r)&&Object.keys(n[r]).includes(o)&&delete n[r][o],Object.keys(n).includes(o)&&Object.keys(n[o]).includes(r)&&delete n[o][r],n}function Te(e,t){var n=JSON.parse(JSON.stringify(e));Object.keys(n).includes(t)&&delete n[t];var r=Object.keys(n);for(var o in r){var u=r[o];Object.keys(n[u]).includes(t)&&delete n[u][t]}return n}function Pe(e,t,n,r,o){void 0===r&&(r=[]),void 0===o&&(o=[]);var u=JSON.parse(JSON.stringify(e));for(var i in r)u=Te(u,r[i]);for(var a in o)u=Ne(u,o[a]);var s=function(e,t){var n={};for(n[t]={},n[t].path=[],n[t].dist=0;;){var r=null,o=null,u=Infinity;for(var i in n)if(n[i]||(n[i]={}),n[i].path){var a=n[i].dist,s=e[i];for(var c in s)if(n[c]||(n[c]={}),!n[c].path){var l=s[c]+a;l<u&&(r=n[i].path,o=c,u=l)}}if(Infinity===u)break;n[o].path=r.concat(o),n[o].dist=u}return n}(u,t)[n];return s.path.unshift(t),s}o.RM=0,o.DP=40,o.NE=-40,o.PE=40;var Ee=function(){function e(){this.paths=[],this.sortedpaths=[]}var t=e.prototype;return t.len=function(){return this.sortedpaths.length},t.push=function(e,t){t&&!Re(this.paths,t)&&(this.sortedpaths.push([e,t]),this.sortedpaths.sort((function(e,t){return e[0]-t[0]})),this.paths.push(t))},t.pop=function(){var e=this.sortedpaths.shift()[1];return this.paths.splice(this.paths.indexOf(e),1),e},e}();function Ae(e,t){return Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every((function(e,n){return e===t[n]}))}function Re(e,t){var n=JSON.stringify(t);for(var r in e)if(JSON.stringify(e[r])==n)return!0;return!1}function je(e,t,n){var r,o,u,i,a,s,c,l,p,f,d,v,h,m,k,w;return R().wrap((function(g){for(;;)switch(g.prev=g.next){case 0:r=[],o=new Ee,u=null;case 3:if(u)for(a=[],s=[],c=1;c<u.length;c++){for(f in l=u.slice(0,c),p=l.length,r)Ae((d=r[f]).slice(0,c),l)&&s.push([d[c-1],d[c]]);try{v=Pe(e,l[l.length-1],n,a=a,s=s),h=v.dist,m=v.path,k=l.slice(0,l.length-1).concat(m),o.push(p+h,k)}catch(e){}a.push(l[l.length-1])}else i=Pe(e,t,n),o.push(i.dist,i.path);if(!o.sortedpaths){g.next=19;break}return g.prev=6,w=o.pop(),g.next=10,w;case 10:r.push(w),u=w,g.next=17;break;case 14:return g.prev=14,g.t0=g.catch(6),g.abrupt("break",22);case 17:g.next=20;break;case 19:return g.abrupt("break",22);case 20:g.next=3;break;case 22:case"end":return g.stop()}}),re,null,[[6,14]])}function Le(e,t,n,r,o){return void 0===o&&(o=3),function(o){var u=[];o<2&&(o=2);for(var i=je(e,t,n),a=1;a<=r;a++)try{var s=i.next().value;if(s&&!Re(u,s)){if(s.length>o)break;u.push(s)}}catch(e){break}return u}(o)}function De(e,t,n,r){return Fe.apply(this,arguments)}function Fe(){return(Fe=L(R().mark((function e(t,n,r,o){var u;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===o&&(o=3),u=Me(t),e.abrupt("return",Le(u,n,r,100,o));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Me(e){var t={};return function(e,t){for(var n in t)Oe(e,t[n])}(t,e.filter((function(e){return"0"!=e.token1Supply&&"0"!=e.token2Supply})).map((function(e){return[e.token1Id,e.token2Id]}))),t}function Ce(e,t,n,r,o){return Be.apply(this,arguments)}function Be(){return(Be=L(R().mark((function e(t,n,r,o,u){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ge(t,n,r,o,u);case 2:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ge(e,t){return e.filter((function(e){return e.outputToken===t})).map((function(e){return new o(e.estimate)})).reduce((function(e,t){return e.plus(t)}),new o(0))}var We=function(e){var t=e.tokenIn,n=e.tokenOut,r=e.pool,u=Number(e.amountIn)*(1e4-r.fee),i=N(t.decimals,r.supplies[t.id]),a=N(n.decimals,r.supplies[n.id]);return{token:t,estimate:new o((u*Number(a)/(1e4*Number(i)+u)).toString()).toFixed(),pool:r,outputToken:n.id,inputToken:t.id}},Je=function(e){var t=e.tokenIn,n=e.tokenOut,r=e.amountIn,o=e.stablePool,u=b(o),i=te(t.id,n.id,r,o,u),a=i[0],s=i[2],c=a<0||isNaN(a)?"0":A(P(a.toString()),0),l=a<0||isNaN(a)||isNaN(s)?"0":A(P(s.toString()),0);return{estimate:N(u,c),noFeeAmountOut:N(u,l),pool:o,token:t,outputToken:n.id,inputToken:t.id}},Ue=function(e){var t=e.tokenIn,n=e.tokenOut,r=e.simplePools,o=e.amountIn,i=e.stablePools;if(!r||0===r.length)throw d;var a=r.filter((function(e){return e.tokenIds.includes(t.id)&&e.tokenIds.includes(n.id)})).map((function(e){return We({tokenIn:t,tokenOut:n,pool:e,amountIn:o})})),s=null==i?void 0:i.filter((function(e){return e.token_account_ids.includes(t.id)&&e.token_account_ids.includes(n.id)})),c=null==s?void 0:s.map((function(e){return Je({tokenIn:t,tokenOut:n,amountIn:o,stablePool:e})})),l=1===a.length?a[0]:u.maxBy(a,(function(e){return Number(e.estimate)}));if(!c)return l;var p=1===c.length?c[0]:u.maxBy(c,(function(e){return Number(e.estimate)}));return Number(null==l?void 0:l.estimate)>Number(null==p?void 0:p.estimate)?l:p},qe=function(e){var t=e.tokenInId,n=e.tokenOutId;return e.stablePools.filter((function(e){return e.tokenIds.includes(t)&&e.tokenIds.includes(n)&&t!==n}))},$e=function(e){var t=e.tokenInId,n=e.tokenOutId;return t===n?[]:e.pools.filter((function(e){return e.tokenIds.includes(t)&&e.tokenIds.includes(n)}))},Ke=function(){var e=L(R().mark((function e(t){var n,r,o,u,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.tokenIn,r=t.tokenOut,o=t.amountIn,i=t.pool,!(u=t.stablePoolDetail)){e.next=5;break}return e.abrupt("return",Je({tokenIn:n,tokenOut:r,stablePool:u,amountIn:o}));case 5:return e.abrupt("return",We({tokenIn:n,tokenOut:r,pool:i,amountIn:o}));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();function Ve(e,t,n,r,o,u){return Ye.apply(this,arguments)}function Ye(){return(Ye=L(R().mark((function e(t,n,r,i,a,s){var c,l,p,f,d,v,h,m,k,w,b,I,_,x,S,O,P,E,A,j,L,F,C,B,G,W,J,U,q,V,Y,H,Z,z,Q,X,ee,te,ne,re,oe,ue,ie,ae,se;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g(a,t.id)||g(a,n.id)){e.next=2;break}return e.abrupt("return",{actions:[],estimate:"0"});case 2:if(c=a.reduce((function(e,t){var n;return D({},e,((n={})[t.id]=t,n))}),{}),l=T(t.decimals,r),d=[],v=[],h=[],m=[],k=[],g(a,t.id))for(d=i.filter((function(e){return e.tokenIds.includes(t.id)})),w=d.map((function(e){return e.tokenIds.filter((function(e){return e!==t.id}))})).flat(),b=M(w);!(I=b()).done;)x=qe({tokenInId:_=I.value,tokenOutId:n.id,stablePools:i}),S=$e({tokenInId:_,tokenOutId:n.id,pools:s}),O=S.concat(x),v.push.apply(v,O.filter((function(e){var t=Object.values(e.supplies);return new o(t[0]).times(new o(t[1])).gt(0)})));if(g(a,n.id))for(m=i.filter((function(e){return e.tokenIds.includes(n.id)})),P=m.map((function(e){return e.tokenIds.filter((function(e){return e!==n.id}))})).flat(),E=M(P);!(A=E()).done;)L=qe({tokenInId:t.id,tokenOutId:j=A.value,stablePools:i}),F=$e({tokenInId:t.id,tokenOutId:j,pools:s}),C=F.concat(L),h.push.apply(h,C.filter((function(e){var t=Object.values(e.supplies);return new o(t[0]).times(new o(t[1])).gt(0)})));for(B=M(d);!(G=B()).done;)for(J=(W=G.value).tokenIds.filter((function(e){return e!==t.id})),U=function(){var e=V.value,t=v.filter((function(t){return t.tokenIds.includes(e)&&t.tokenIds.includes(n.id)&&e!==n.id})),r=u.maxBy(t,(function(e){return Number(new o(N(n.decimals,e.supplies[n.id])))}));e===n.id&&(r=W),W&&r&&k.push(W.id===r.id?[W]:[W,r])},q=M(J);!(V=q()).done;)U();for(Y=0,H=h;Y<H.length;Y++)for(z=(Z=H[Y]).tokenIds.filter((function(e){return e!==t.id})),Q=function(){var e=ee.value,t=m.filter((function(t){return t.tokenIds.includes(e)&&t.tokenIds.includes(n.id)&&e!==n.id})),r=u.maxBy(t,(function(e){return Number(new o(N(n.decimals,e.supplies[n.id])))}));e===n.id&&(r=Z),Z&&r&&k.push(Z.id===r.id?[Z]:[Z,r])},X=M(z);!(ee=X()).done;)Q();if(!(k.length>0)){e.next=36;break}return e.next=16,K(k.map((function(e){return e.map((function(e){return e.tokenIds})).flat()})).flat());case 16:if(te=e.sent,ne=1===k.length?k[0]:u.maxBy(k,(function(e){if(1===e.length){if(y(a,e[0].id)){var o=qe({tokenInId:t.id,tokenOutId:n.id,stablePools:i})[0],u=a.find((function(e){return e.id===o.id}));return Number(Je({tokenIn:t,tokenOut:n,stablePool:u,amountIn:r}).estimate)}return Number(We({tokenIn:t,tokenOut:n,amountIn:r,pool:e[0]}).estimate)}var s=e[0],l=e[1],p=e[0].tokenIds.find((function(t){return e[1].tokenIds.includes(t)})),f=te[p],d=D({},y(a,s.id)?Je({tokenIn:t,tokenOut:f,amountIn:r,stablePool:c[s.id]}):We({tokenIn:t,tokenOut:f,amountIn:r,pool:s})),v=D({},y(a,l.id)?Je({tokenIn:f,tokenOut:n,amountIn:d.estimate,stablePool:c[l.id]}):We({tokenIn:f,tokenOut:n,pool:l,amountIn:d.estimate}));return Number(v.estimate)}))){e.next=20;break}return e.abrupt("return",{actions:[],estimate:"0"});case 20:if(1!==ne.length){e.next=26;break}return re=ne[0],e.next=24,Ke({tokenIn:t,tokenOut:n,amountIn:r,pool:re,stablePoolDetail:c[re.id]});case 24:return e.abrupt("return",{actions:[D({},oe=e.sent,{pool:D({},re,{parsedAmountIn:l}),tokens:[t,n],inputToken:t.id,outputToken:n.id,totalInputAmount:T(t.decimals,r)})],estimate:oe.estimate});case 26:return p=ne[0],f=ne[1],ue=ne[0].tokenIds.find((function(e){return ne[1].tokenIds.includes(e)})),e.next=31,$(ue);case 31:return ie=e.sent,(ae=D({},y(a,p.id)?Je({tokenIn:t,tokenOut:ie,amountIn:r,stablePool:c[p.id]}):We({tokenIn:t,tokenOut:ie,amountIn:r,pool:p}),{tokens:[t,ie,n],inputToken:t.id,outputToken:ie.id})).pool.partialAmountIn=l,se=D({},y(a,f.id)?Je({tokenIn:ie,tokenOut:n,amountIn:ae.estimate,stablePool:c[f.id]}):We({tokenIn:ie,tokenOut:n,amountIn:ae.estimate,pool:f}),{tokens:[t,ie,n],inputToken:ie.id,outputToken:n.id}),e.abrupt("return",{actions:[ae,se],estimate:se.estimate});case 36:return e.abrupt("return",{actions:[],estimate:"0"});case 37:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var He=function(){var e=L(R().mark((function e(t){var n,r,u,i,a,s,c,l,v,h,m,k,g,y,b,I;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=t.amountIn,i=t.simplePools,a=t.options,(n=t.tokenIn).id!==(r=t.tokenOut).id){e.next=3;break}throw p;case 3:if(!O.test(u)){e.next=5;break}throw f;case 5:if(c=(s=a||{}).enableSmartRouting,l=s.stablePools,v=s.stablePoolsDetail,h=T(n.decimals,u),c){e.next=12;break}return m=Ue({tokenIn:n,tokenOut:r,simplePools:i,amountIn:u,stablePools:v}),e.abrupt("return",[D({},m,{pool:D({},null==m?void 0:m.pool,{partialAmountIn:h})})]);case 12:return k=i.map((function(e){return w(e)})),e.next=15,Ce(k,n.id,r.id,h);case 15:return y=Ge(g=e.sent,r.id).toString(),e.next=19,Ve(n,r,u,l||[],v||[],i);case 19:if(I=(b=e.sent).estimate.toString(),!new o(y||"0").gte(I||"0")){e.next=27;break}if(null!=g&&g.length){e.next=24;break}throw d;case 24:return e.abrupt("return",g);case 27:return e.abrupt("return",b.actions);case 28:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Ze=new t.providers.JsonRpcProvider({url:i().nodeUrl});e.DEFAULT_PAGE_LIMIT=100,e.FEE_DIVISOR=1e4,e.NoPoolError=d,e.NotLoginError=v,e.ONE_YOCTO_NEAR="0.000000000000000000000001",e.ONLY_ZEROS=O,e.RATED_POOL_LP_TOKEN_DECIMALS=24,e.REF_FI_CONTRACT_ID=s,e.STABLE_LP_TOKEN_DECIMALS=18,e.STORAGE_TO_REGISTER_WITH_MFT="0.1",e.SameInputTokenError=p,e.SwapRouteError=h,e.TokenNotExistError=m,e.ZeroInputError=f,e.calc_d=Q,e.calc_swap=ee,e.calc_y=X,e.config=a,e.convertToPercentDecimal=_,e.estimateSwap=He,e.fetchAllRefPools=z,e.formatError=c,e.formatWithCommas=E,e.ftGetStorageBalance=function(e,t){return void 0===t&&(t=W.getAccountId()),U(e,{methodName:"storage_balance_of",args:{account_id:t}})},e.ftGetTokenMetadata=$,e.ftGetTokensMetadata=K,e.ftViewFunction=U,e.getAmount=function(e){return new n(e&&t.utils.format.parseNearAmount(e)||"0")},e.getConfig=i,e.getGas=function(e){return new n(e||"100000000000000")},e.getHybridStableSmart=Ve,e.getMemorySigner=function(e){var n=require("os").homedir(),r=require("path").join(n,".near-credentials"),o=new t.keyStores.UnencryptedFileSystemKeyStore(r),u=new t.InMemorySigner(o);console.log(u)},e.getPoolEstimate=Ke,e.getPoolsByTokens=$e,e.getRatedPoolDetail=V,e.getRefPools=Z,e.getSimplePoolEstimate=We,e.getStablePoolDecimal=b,e.getStablePoolEstimate=Je,e.getStablePoolsDetail=H,e.getStablePoolsThisPair=qe,e.getSwappedAmount=te,e.getTotalPools=q,e.getUnRatedPoolDetail=Y,e.instantSwap=C,e.isStablePool=y,e.isStablePoolToken=g,e.keyStore=B,e.near=G,e.parsePool=k,e.percentLess=S,e.percentOf=x,e.poolFormatter=w,e.provider=Ze,e.refFiViewFunction=J,e.round=I,e.scientificNotationToString=P,e.singlePoolSwap=Ue,e.toNonDivisibleNumber=T,e.toPrecision=A,e.toReadableNumber=N,e.unNamedError=l,e.wallet=W,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ref-sdk.umd.production.min.js.map
