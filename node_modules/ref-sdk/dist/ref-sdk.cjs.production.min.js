"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=require("near-api-js"),n=t(require("bn.js")),r=require("mathjs"),o=t(require("big.js")),u=t(require("lodash"));function i(t){switch(void 0===t&&(t=process.env.NEAR_ENV),t){case"mainnet":return{networkId:"mainnet",nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.near.org",WRAP_NEAR_CONTRACT_ID:"wrap.near",REF_FI_CONTRACT_ID:"v2.ref-finance.near"};case"testnet":return{networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",walletUrl:"https://wallet.testnet.near.org",WRAP_NEAR_CONTRACT_ID:"wrap.testnet",REF_FI_CONTRACT_ID:"ref-finance-101.testnet"};default:return{networkId:"mainnet",nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.near.org",REF_FI_CONTRACT_ID:"v2.ref-finance.near",WRAP_NEAR_CONTRACT_ID:"wrap.near"}}}var a=i(),s=a.REF_FI_CONTRACT_ID,c=function(t){return new Error(t)},l=c("Something wrong happened"),p=c("Input token should be different with output token"),f=c("Input amount should be greater than 0"),d=c("No pool found for the input tokens"),v=c("Please login in first"),h=c("Something wrong happened, we don't get correct routes corrreponding to current input"),m=c("This token doesn't exist in "+i().networkId),k=function(t,e){return{id:Number(e&&e>=0?e:t.id),tokenIds:t.token_account_ids,supplies:t.amounts.reduce((function(e,n,r){return e[t.token_account_ids[r]]=n,e}),{}),fee:t.total_fee,shareSupply:t.shares_total_supply,tvl:t.tvl,token0_ref_price:t.token0_ref_price,pool_kind:t.pool_kind}},w=function(t){return{id:t.id,token1Id:t.tokenIds[0],token2Id:t.tokenIds[1],token1Supply:t.supplies[t.tokenIds[0]],token2Supply:t.supplies[t.tokenIds[1]],fee:t.fee,shares:t.shareSupply,token0_price:t.token0_ref_price||"0"}},g=function(t,e){return t.map((function(t){return t.token_account_ids})).flat().includes(e.toString())},y=function(t,e){return t.map((function(t){return t.id.toString()})).includes(e.toString())},b=function(t){return"RATED_SWAP"===t.pool_kind?24:18},x=function(t,e){return Number.isInteger(Number(e))?e:Math.ceil(Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)).toString()},I=function(t){return r.divide(t,100)},_=function(t,e){return r.evaluate(I(t)+" * "+e)},S=function(t,e){return r.format(r.evaluate(e+" - "+_(t,e)),{notation:"fixed"})},O=/^0*\.?0*$/,N=function(t,e){return void 0===e&&(e="0"),t?((e.substring(0,e.length-t)||"0")+"."+e.substring(e.length-t).padStart(t,"0").substring(0,t)).replace(/\.?0+$/,""):e},T=function(t,e){if(null==t)return e;var n=e.split("."),r=n[1];return(""+n[0]+(void 0===r?"":r).padEnd(t,"0").slice(0,t)).replace(/^0+/,"").padStart(1,"0")},P=function(t){var e,n;if(!/e/.test(t)||!t)return t;var r=!0;/e-/.test(t)&&(r=!1);var o=Number(t)<0?"-":"",u=Number(null==(e=t.match(/\d+$/))?void 0:e[0]),i=null==(n=t.match(/[\d\.]+/))?void 0:n[0];if(!u||!i)return t;var a,s,c=i.includes(".");return c?(a=i.split(".")[0],s=i.split(".")[1]):(a=i,s=""),r?c?s.length<=u?o+a+s.padEnd(u,"0"):o+a+s.substring(0,u)+"."+s.substring(u):o+a.padEnd(u+a.length,"0"):c?o+a.padStart(u+a.length,"0").replace(/^0/,"0.")+s:o+a.padStart(u+a.length,"0").replace(/^0/,"0.")},E=function(t){for(var e=/(-?\d+)(\d{3})/;e.test(t);)t=t.replace(e,"$1,$2");return t},A=function(t,e,n,r){void 0===n&&(n=!1),void 0===r&&(r=!0);var o=t.split("."),u=o[0],i=o[1],a=void 0===i?"":i,s=((n?E(u):u)+"."+a.slice(0,e)).replace(/\.$/,"");if(r&&0===Number(s)&&s.length>1){var c=s.lastIndexOf("0");s=s.slice(0,c)+s.slice(c).replace("0","1")}return s};function R(){R=function(){return t};var t={},e=Object.prototype,n=e.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",u=r.asyncIterator||"@@asyncIterator",i=r.toStringTag||"@@toStringTag";function a(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{a({},"")}catch(t){a=function(t,e,n){return t[e]=n}}function s(t,e,n,r){var o=Object.create((e&&e.prototype instanceof p?e:p).prototype),u=new I(r||[]);return o._invoke=function(t,e,n){var r="suspendedStart";return function(o,u){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw u;return{value:void 0,done:!0}}for(n.method=o,n.arg=u;;){var i=n.delegate;if(i){var a=y(i,n);if(a){if(a===l)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=c(t,e,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===l)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}(t,n,u),o}function c(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=s;var l={};function p(){}function f(){}function d(){}var v={};a(v,o,(function(){return this}));var h=Object.getPrototypeOf,m=h&&h(h(_([])));m&&m!==e&&n.call(m,o)&&(v=m);var k=d.prototype=p.prototype=Object.create(v);function w(t){["next","throw","return"].forEach((function(e){a(t,e,(function(t){return this._invoke(e,t)}))}))}function g(t,e){var r;this._invoke=function(o,u){function i(){return new e((function(r,i){!function r(o,u,i,a){var s=c(t[o],t,u);if("throw"!==s.type){var l=s.arg,p=l.value;return p&&"object"==typeof p&&n.call(p,"__await")?e.resolve(p.__await).then((function(t){r("next",t,i,a)}),(function(t){r("throw",t,i,a)})):e.resolve(p).then((function(t){l.value=t,i(l)}),(function(t){return r("throw",t,i,a)}))}a(s.arg)}(o,u,r,i)}))}return r=r?r.then(i,i):i()}}function y(t,e){var n=t.iterator[e.method];if(void 0===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,y(t,e),"throw"===e.method))return l;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=c(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,l;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,l):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,l)}function b(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function I(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(b,this),this.reset(!0)}function _(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,u=function e(){for(;++r<t.length;)if(n.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return u.next=u}}return{next:S}}function S(){return{value:void 0,done:!0}}return f.prototype=d,a(k,"constructor",d),a(d,"constructor",f),f.displayName=a(d,i,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===f||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):(t.__proto__=d,a(t,i,"GeneratorFunction")),t.prototype=Object.create(k),t},t.awrap=function(t){return{__await:t}},w(g.prototype),a(g.prototype,u,(function(){return this})),t.AsyncIterator=g,t.async=function(e,n,r,o,u){void 0===u&&(u=Promise);var i=new g(s(e,n,r,o),u);return t.isGeneratorFunction(n)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},w(k),a(k,i,"Generator"),a(k,o,(function(){return this})),a(k,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},t.values=_,I.prototype={constructor:I,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(n,r){return i.type="throw",i.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var u=this.tryEntries[o],i=u.completion;if("root"===u.tryLoc)return r("end");if(u.tryLoc<=this.prev){var a=n.call(u,"catchLoc"),s=n.call(u,"finallyLoc");if(a&&s){if(this.prev<u.catchLoc)return r(u.catchLoc,!0);if(this.prev<u.finallyLoc)return r(u.finallyLoc)}else if(a){if(this.prev<u.catchLoc)return r(u.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<u.finallyLoc)return r(u.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var u=o;break}}u&&("break"===t||"continue"===t)&&u.tryLoc<=e&&e<=u.finallyLoc&&(u=null);var i=u?u.completion:{};return i.type=t,i.arg=e,u?(this.method="next",this.next=u.finallyLoc,l):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),x(n),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;x(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:_(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},t}function L(t,e,n,r,o,u,i){try{var a=t[u](i),s=a.value}catch(t){return void n(t)}a.done?e(s):Promise.resolve(s).then(r,o)}function j(t){return function(){var e=this,n=arguments;return new Promise((function(r,o){var u=t.apply(e,n);function i(t){L(u,r,o,i,a,"next",t)}function a(t){L(u,r,o,i,a,"throw",t)}i(void 0)}))}}function D(){return(D=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function F(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function M(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return F(t,void 0);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?F(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var C=function(){var t=j(R().mark((function t(e){var n,r,o,u,i,a,c,l,p,f,d;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.tokenIn,o=e.tokenOut,u=e.amountIn,i=e.slippageTolerance,c=[],(null==(n=(a=e.swapTodos).at(-1))?void 0:n.outputToken)===o.id){t.next=4;break}throw h;case 4:for(f in l=[],p=a.map((function(t){return[t.inputToken,t.outputToken]})))l.push((d=p[f])[0]===r.id&&d[1]===o.id?{pool_id:a[f].pool.id,token_in:r.id,token_out:o.id,amount_in:a[f].pool.partialAmountIn,min_amount_out:x(o.decimals,T(o.decimals,S(i,a[f].estimate)))}:d[0]===r.id?{pool_id:a[f].pool.id,token_in:d[0],token_out:d[1],amount_in:a[f].pool.partialAmountIn,min_amount_out:"0"}:{pool_id:a[f].pool.id,token_in:d[0],token_out:d[1],min_amount_out:x(o.decimals,T(o.decimals,S(i,a[f].estimate)))});return c.push({receiverId:r.id,functionCalls:[{methodName:"ft_transfer_call",args:{receiver_id:s,amount:T(r.decimals,u),msg:JSON.stringify({force:0,actions:l})},gas:"180000000000000",amount:"0.000000000000000000000001"}]}),t.abrupt("return",c);case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),B=new e.keyStores.BrowserLocalStorageKeyStore,G=new e.Near(D({keyStore:B,headers:{}},a)),W=new e.WalletConnection(G,s),U=function(t){var e=t.methodName,n=t.args;return W.account().viewFunction(s,e,n)},q=function(t,e){var n=e.methodName,r=e.args;return W.account().viewFunction(t,n,r)},J=function(){var t=j(R().mark((function t(){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",U({methodName:"get_number_of_pools"}));case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),$=function(){var t=j(R().mark((function t(e){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,q(e,{methodName:"ft_metadata"}).catch((function(){throw m}));case 2:return t.abrupt("return",D({},t.sent,{id:e}));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),K=function(){var t=j(R().mark((function t(e){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Promise.all(e.map((function(t){return $(t)})));case 2:return t.abrupt("return",t.sent.reduce((function(t,n,r){var o;return D({},t,((o={})[e[r]]=n,o))}),{}));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),V=function(){var t=j(R().mark((function t(e){var n;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.id,t.abrupt("return",U({methodName:"get_rated_pool",args:{pool_id:Number(n)}}).then((function(t){return D({},t,{id:Number(n),pool_kind:"RATED_SWAP"})})).catch((function(){throw l})));case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Y=function(){var t=j(R().mark((function t(e){var n;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.id,t.abrupt("return",U({methodName:"get_stable_pool",args:{pool_id:Number(n)}}).then((function(t){return D({},t,{id:Number(n),pool_kind:"STABLE_SWAP",rates:t.c_amounts.map((function(t){return T(18,"1")}))})})).catch((function(){throw l})));case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),H=function(){var t=j(R().mark((function t(e){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",Promise.all(e.map((function(t){return"RATED_SWAP"===t.pool_kind?V({id:t.id}):Y({id:t.id})}))));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Z=function(){var t=j(R().mark((function t(e,n){var r;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===e&&(e=1),void 0===n&&(n=100),r=(e-1)*n,t.next=5,U({methodName:"get_pools",args:{from_index:r,limit:n}});case 5:return t.abrupt("return",t.sent.map((function(t,e){return k(t,e+r)})));case 7:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),z=function(){var t=j(R().mark((function t(){var e,n;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,J();case 2:return e=Math.ceil(t.sent/100),t.next=6,Promise.all([].concat(Array(e)).map((function(t,e){return Z(e+1)})));case 6:return n=t.sent.flat(),t.abrupt("return",{simplePools:n.filter((function(t){return t.pool_kind&&"SIMPLE_POOL"===t.pool_kind})),unRatedPools:n.filter((function(t){return t.pool_kind&&"STABLE_SWAP"===t.pool_kind})),ratedPools:n.filter((function(t){return t.pool_kind&&"RATED_SWAP"===t.pool_kind}))});case 8:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Q=function(t,e){for(var n=e.length,r=u.sum(e),o=0,i=r,a=0;a<256;a++){for(var s,c=i,l=M(e);!(s=l()).done;)c=c*i/(s.value*n);o=i;var p=t*Math.pow(n,n);if(i=o*(c*n+p*r)/(o*(p-1)+c*(n+1)),Math.abs(i-o)<=1)break}return i},X=function(t,e,n,r,o){for(var u=n.length,i=t*Math.pow(u,u),a=Q(t,n),s=e,c=a*a/e,l=0;l<u;l++)l!=r&&l!=o&&(s+=n[l],c=c*a/n[l]);c=c*a/(i*Math.pow(u,u));for(var p=a/i+s,f=0,d=a,v=0;v<256&&(f=d,d=(Math.pow(d,2)+c)/(2*d+p-a),!(Math.abs(d-f)<=1));v++);return d},tt=function(t,e,n,r,o,u){var i=X(t,n+o[e],o,e,r),a=o[r]-i,s=function(t,e){return t*e/1e4}(a,u);return[a-s,s,a]},et=function(t,e,n,r,u){var i=r.amp,a=r.total_fee,s=r.token_account_ids.findIndex((function(e){return e===t})),c=r.token_account_ids.findIndex((function(t){return t===e})),l=r.rates.map((function(t){return N(u,t)})),p=r.c_amounts.map((function(t){return N(u,t)})).map((function(t,e){return T(u,P(new o(t||0).times(new o(l[e])).toString()))})).map((function(t){return Number(t)})),f=Number(T(u,P(new o(n).times(new o(l[s])).toString()))),d=tt(i,s,f,c,p,a),v=d[1],h=d[2];return[d[0]/Number(l[c]),v,h/Number(l[c])]};function nt(t,e){e=new o(e);for(var n=(t=t.map((function(t){return new o(t).round()}))).map((function(t){return new o(t)})).reduce((function(t,e){return t.plus(e)}),new o(0)),r=e.minus(n),u=new o(0),i=0,a=0;a<t.length;a++)t[a].gt(u)&&(i=a,u=t[a]);for(var s=[],c=0;c<t.length;c++)s.push(c===i?t[c].plus(r).toString():t[c].toString());return s}o.RM=0,o.DP=40,o.NE=-40,o.PE=40;var rt=R().mark(Lt);function ot(t){if(t<BigInt(0))throw"square root of negative numbers is not supported";return t<BigInt(2)?t:function t(e,n){var r=e/n+n>>BigInt(1);return n===r||n===r-BigInt(1)?n:t(e,r)}(t,BigInt(1))}function ut(t,e){if(t.length||(t=[t]),1==t.length)var n=new o(t[0].reserves[e[0]]);else if(2==t.length){var r=t[1];n=new o(t[0].reserves[e[0]]).times(new o(r.reserves[e[1]]))}return n}function it(t,e){if(t.length||(t=[t]),1==t.length)var n=t[0],r=new o(1e4).minus(new o(n.fee)).div(new o(1e4)),u=o(r);else if(2==t.length){var i=t[0],a=t[1],s=new o(1e4).minus(new o(i.fee)).div(new o(1e4)),c=new o(1e4).minus(new o(a.fee)).div(o(1e4));u=new o(a.reserves[e[1]]).times(new o(s)).plus(new o(i.reserves[e[1]]).times(s).times(c))}return u}function at(t,e){if(t.length||(t=[t]),1==t.length){var n,r=t[0],u=e[0],i=e[1],a=new o(1e4).minus(new o(r.fee)).div(new o(1e4)),s=r.token2Id,c=r.token2Supply;r.reserves=((n={})[r.token1Id]=r.token1Supply,n[s]=c,n);var l=new o(r.reserves[u]).times(new o(r.reserves[i]).times(new o(a)))}else if(2==t.length){var p,f,d=t[0],v=t[1],h=d.token2Id,m=d.token2Supply;d.reserves=((p={})[d.token1Id]=d.token1Supply,p[h]=m,p);var k=v.token2Id,w=v.token2Supply;v.reserves=((f={})[v.token1Id]=v.token1Supply,f[k]=w,f);var g=e[0],y=e[1],b=e[2],x=new o(1e4).minus(o(d.fee)).div(new o(1e4)),I=new o(1e4).minus(new o(v.fee)).div(new o(1e4)),_=new o(d.reserves[g]).times(new o(d.reserves[y])).times(x),S=new o(v.reserves[y]).times(new o(v.reserves[b])).times(I);l=_.times(S)}return l}function st(t,e,n){var r=at(e,n),u=ut(e,n),i=it(e,n);return new o(t).abs().times(new o(ot(BigInt(new o(r).round().toFixed())))).minus(u).div(i)}function ct(t,e){var n=[];for(var r in e){var o=e[r].map((function(t){return t.length})).reduce((function(t,e){return t*e}),1);n.push(o)}var u=[];for(var i in t)for(var a=t[i],s=n[i],c=0;c<s;c++)u.push(a);return u}function lt(t,e,n){void 0===n&&(n=.001);var r=[];for(var o in t){for(var u=t[o],i=[],a=[],s=0;s<u.length-1;s++)a.push([u[s],u[s+1]]);for(var c in a){var l=a[c],p=_t(e,l[0],l[1]);i.push(p)}r.push(i)}return function(t,e){void 0===e&&(e=.001);var n=[];for(var r in t){var o=t[r],u=[];for(var i in o){var a=St(o[i],e);u.push(a)}n.push(u)}return n}(r,n)}function pt(t){var e=[];for(var n in t){var r=t[n].reduce((function(t,e){return t.flatMap((function(t){return e.map((function(e){return[t,e].flat()}))}))}));e.push.apply(e,r)}for(var o in e)e[o].length||(e[o]=[e[o]]);return e}function ft(t,e,n,r){if(r=new o(r),e===t.token1Id&&n===t.token2Id)var u,i=((u={})[e]=new o(t.token1Supply),u[n]=new o(t.token2Supply),u);else{if(e!==t.token2Id||n!==t.token1Id)return new o(0);var a;(a={})[n]=new o(t.token1Supply),a[e]=new o(t.token2Supply),i=a}var s=new o(1e4).minus(new o(t.fee)).div(new o(1e4)),c=r.times(s).times(i[n]),l=i[e].plus(s.times(r));return c.div(l)}function dt(t,e,n){if(new o(n).eq(new o(0)))return new o(0);if(n=new o(n),t.length||(t=[t]),1==t.length)var r=ft(t[0],e[0],e[1],n);else 2==t.length&&(r=function(t,e,n,r,u){for(var i in u=new o(u),t){var a=t[i];a.gamma=new o(1e4).minus(new o(a.fee)).div(new o(1e4))}var s,c,l=t[0],p=t[1];if(e===l.token1Id&&n===l.token2Id)l.reserves=((s={})[e]=new o(l.token1Supply),s[n]=new o(l.token2Supply),s);else if(n===l.token1Id&&e===l.token2Id){var f;l.reserves=((f={})[n]=new o(l.token1Supply),f[e]=new o(l.token2Supply),f)}if(n===p.token1Id&&r===p.token2Id)p.reserves=((c={})[n]=new o(p.token1Supply),c[r]=new o(p.token2Supply),c);else if(r===p.token1Id&&n===p.token2Id){var d;p.reserves=((d={})[r]=new o(p.token1Supply),d[n]=new o(p.token2Supply),d)}var v=new o(l.reserves[n]),h=new o(l.reserves[e]),m=new o(p.reserves[n]),k=new o(p.reserves[r]),w=l.gamma,g=p.gamma,y=u.times(v).times(k).times(w).times(g),b=m.times(h).plus(u.times(m.times(w).plus(v.times(w).times(g))));return y.div(b)}(t,e[0],e[1],e[2],n));return r}function vt(t,e,n){var r=function t(e,n,r){var u=function(t,e,n){var r=[];for(var o in e)r.push(st(t,e[o],n[o]));return r}(function(t,e,n){var r=function(t,e){var n=new o(0);for(var r in t){var u=t[r],i=e[r],a=at(u,i),s=new o(ot(BigInt(new o(a).round().toFixed()))),c=it(u,i),l=new o(c);n=n.plus(s.div(l))}return n}(t,e),u=function(t,e){var n=new o(0);for(var r in t){var u=t[r],i=e[r],a=new o(ut(u,i)),s=new o(it(u,i));n=n.plus(a.div(s))}return n}(t,e);return new o(n).plus(u).div(r)}(e,n,r=new o(r)),e,n);u.every((function(t){return t.lt(new o(0))}))&&(u=u.map((function(t){return t.times(new o(-1))}))),u.some((function(t){return t.lt(new o(0))}))&&(u=function(e,n,r,u){u=new o(u);var i=[];for(var a in r)r[a].gt(new o(0))&&i.push(a);var s=[],c=[];for(var a in i){var l=i[a];s.push(e[l]),c.push(n[l])}r=t(s,c,u);var p={};for(var a in i)p[i[a]]=r[a];var f=[];for(var a in e)if(i.includes(a))f.push(p[a]);else{var d=new o(0);f.push(d)}return f}(e,n,u,r));var i=u.reduce((function(t,e){return t.plus(e)}),new o(0));return u.map((function(t){return t.div(i).times(new o(r))}))}(t,e,n),u=[];for(var i in t){var a=dt(t[i],e[i],r[i]);u.push(a)}return{result:u,allocations:r}}function ht(t,e,n){var r=vt(t,e,n),u=r.result,i=r.allocations;return i=nt(i,n),new o(0),new o(0),{input:i,output:u.map((function(t){return new o(t)})).reduce((function(t,e){return t.plus(e)}),new o(0))}}function mt(t,e,n,r,o,u){return kt.apply(this,arguments)}function kt(){return(kt=j(R().mark((function t(e,n,r,u,i,a){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===i&&(i=3),void 0===a&&(a=.001),t.abrupt("return",function(){var t=j(R().mark((function t(u){var s,c,l,p,f;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return u=new o(u),t.next=3,Dt(e,n,r,i);case 3:if((s=t.sent).length){t.next=6;break}return t.abrupt("return",{allocations:[],outputs:new o(0),routes:[],nodeRoutes:[]});case 6:return t.next=8,lt(s,e,a);case 8:return c=t.sent,t.next=11,pt(c);case 11:return l=t.sent,t.next=14,ct(s,c);case 14:return p=t.sent,t.next=17,ht(l,p,u);case 17:return t.abrupt("return",{allocations:(f=t.sent).input,outputs:f.output,routes:l,nodeRoutes:p});case 21:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()(u));case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function wt(t,e,n){return function(t,e,n){var r=n.map((function(t){return new o(t)})).reduce((function(t,e){return t.plus(e)}),new o(0)).toString(),u=[];for(var i in t){var a=t[i],s=e[i],c=n[i];if(!new o(c).eq(new o(0))&&(a.length||(a=[a]),a[0]))for(var l in a){var p=a[l];if(0==l){var f={pool:p,allocation:c.toString(),inputToken:s[0],outputToken:s[1],nodeRoute:s,route:a,allRoutes:t,allNodeRoutes:e,totalInputAmount:r,allAllocations:n};if(u.push(f),s.length>2)var d=ft(p,s[0],s[1],c)}else f={pool:p,allocation:d.toString(),inputToken:s[1],outputToken:s[2],nodeRoute:s,route:a,allRoutes:t,allNodeRoutes:e,totalInputAmount:r,allAllocations:n},u.push(f)}}return u}(t,e,n)}function gt(t,e,n,r,o,u,i,a,s){return yt.apply(this,arguments)}function yt(){return(yt=j(R().mark((function t(e,n,r,u,i,a,s,c,l){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===i&&(i=3),void 0===a&&(a=.001),void 0===s&&(s=2),void 0===c&&(c=4),void 0===l&&(l=[]),t.abrupt("return",function(){var t=j(R().mark((function t(u){var p,f,d,v,h,m,k,w,g,y,b,x,I,_,S,O,N,T,P,E,A,L,D,F,C,B,G,W,U,q,J,K,V,Y,H,Z,z,Q,X,tt,et,rt,ot,ut,it,at,st,ct,lt,pt,dt,ht,kt,yt,xt,_t,St,Ot,Nt,Tt,Pt,Et,At,Rt,Lt,jt,Dt,Ft,Mt,Ct,Bt,Gt,Wt,Ut,qt;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u){t.next=2;break}return t.abrupt("return",[]);case 2:return u=new o(u),e=e.filter((function(t){return!l.includes(t.id)})),t.next=6,mt(e,n,r,u,i,a);case 6:for(d=(p=t.sent).routes,v=p.nodeRoutes,h=It(f=p.allocations),m=h.slice(0,10),k=[],w=[],g=M(m);!(y=g()).done;)k.push(d[b=y.value]),w.push(v[b]);for(T in d=k,v=w,x=new o(0),I=p.allocations,_=p.nodeRoutes,O=[],N=[],S=p.routes)2==(P=_[T]).length&&(O.push(P),N.push(S[T]));if(E=!1,O.length>0){if(A=vt(N,O,u),D=A.result,(L=A.allocations).length>c){for(G in F=(F=It(L)).slice(0,c),C=[],B=[],F)C.push(N[F[G]]),B.push(O[F[G]]);A=vt(C,B,u),L=A.allocations,D=A.result}W=D.reduce((function(t,e){return t.plus(e)}),new o(0)),new o(W).gt(x)&&(I=L,x=W,S=N,_=O,E=!0)}U=!1,t.t0=R().keys(d);case 29:if((t.t1=t.t0()).done){t.next=59;break}G=t.t1.value,t.t2=R().keys(d);case 32:if((t.t3=t.t2()).done){t.next=57;break}if(!((q=t.t3.value)>G)){t.next=55;break}for(J=d[G],K=d[q],V=v[G],Y=v[q],H=new Set(J.map((function(t){return t.id}))),Z=new Set(K.map((function(t){return t.id}))),z=!1,Q=M(H);!(X=Q()).done;)Z.has(X.value)&&(z=!0);if(!z){t.next=47;break}return t.abrupt("continue",32);case 47:U=!0,rt=vt(tt=[J,K],et=[V,Y],u),ot=rt.allocations,ut=rt.result.reduce((function(t,e){return t.plus(e)}),new o(0)),new o(ut).gt(x)&&(I=ot,x=ut,S=tt,_=et,E=!1);case 55:t.next=32;break;case 57:t.next=29;break;case 59:if(!U)for(G in d)st=vt(it=[d[G]],at=[v[G]],u),ct=st.allocations,lt=st.result.reduce((function(t,e){return t.plus(e)}),new o(0)),new o(lt).gt(x)&&(I=ct,x=lt,S=it,_=at,E=!1);if(f=I,v=_,!((d=S).length<1)){t.next=65;break}return t.abrupt("return",[]);case 65:for(G in pt=It(f.map((function(t){return new o(t)}))),E&&(s=4),dt=pt.slice(0,s),ht=[],kt=[],dt)ht.push(d[yt=dt[G]]),kt.push(v[yt]);for(G in ht)ht[G].length||(ht[G]=[ht[G]]);if(xt=ht[0].map((function(t){return t.id})),!(ht.length>1)){t.next=84;break}_t=ht[1].map((function(t){return t.id})),St=!1,t.t4=R().keys(_t);case 77:if((t.t5=t.t4()).done){t.next=84;break}if(!xt.includes(_t[G=t.t5.value])){t.next=82;break}return St=!0,t.abrupt("break",84);case 82:t.next=77;break;case 84:if(!St){t.next=109;break}for(G in Ot=[],Nt=[],pt)Ot.push(d[pt[G]]),Nt.push(v[pt[G]]);for(G in Tt=Ot[0].map((function(t){return t.id})),Ot)Ot[G].length||(Ot[G]=[Ot[G]]);Pt=Ot.map((function(t){return t.map((function(t){return t.id}))})),t.t6=R().keys(Pt);case 93:if((t.t7=t.t6()).done){t.next=109;break}G=t.t7.value,t.t8=R().keys(Pt[G]);case 96:if((t.t9=t.t8()).done){t.next=107;break}if(!Tt.includes(Pt[G][q=t.t9.value])){t.next=100;break}return t.abrupt("break",107);case 100:return(Et=Ot[G]).length||(Et=[Et]),ht=[Ot[0],Et],kt=[Nt[0],Nt[G]],t.abrupt("break",107);case 107:t.next=93;break;case 109:At=vt(ht,kt,u),Rt=nt(Rt=At.allocations,u).map((function(t){return new o(t)})),Lt=wt(ht,kt,Rt),jt=[],t.t10=R().keys(Lt);case 116:if((t.t11=t.t10()).done){t.next=139;break}return G=t.t11.value,t.next=120,$(Lt[G].inputToken);case 120:return Ft=t.sent,t.next=123,$(Lt[G].outputToken);case 123:if(Mt=t.sent.decimals,Ct=ft(Lt[G].pool,Lt[G].inputToken,Lt[G].outputToken,Lt[G].allocation),Bt=new o(Ct).div(new o(10).pow(Mt)).toString(),!new o(Ct).lt(new o(1))){t.next=130;break}return l.push(Lt[G].pool.id),t.abrupt("return",gt(e,n,r,u,i=i,a=a,s=s,c=c,l=l));case 130:return Gt=Lt[G].inputToken==n&&Lt[G].outputToken==r?"parallel swap":"stableSmart",t.next=133,Promise.all(Lt[G].nodeRoute.map(function(){var t=j(R().mark((function t(e){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,$(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 133:Wt=t.sent,jt[G]={estimate:Bt,pool:{fee:Lt[G].pool.fee,gamma_bps:new o(1e4).minus(new o(Lt[G].pool.fee)),id:Lt[G].pool.id,partialAmountIn:new o(Lt[G].allocation).round().toString(),supplies:(Dt={},Dt[Lt[G].pool.token1Id]=Lt[G].pool.token1Supply,Dt[Lt[G].pool.token2Id]=Lt[G].pool.token2Supply,Dt),token0_ref_price:Lt[G].pool.token0_price,tokenIds:[Lt[G].pool.token1Id,Lt[G].pool.token2Id],Dex:Lt[G].pool.Dex},status:Gt,token:Ft,outputToken:Lt[G].outputToken,inputToken:Lt[G].inputToken,nodeRoute:Lt[G].nodeRoute,route:Lt[G].route,allRoutes:Lt[G].allRoutes,allNodeRoutes:Lt[G].allNodeRoutes,totalInputAmount:Lt[G].totalInputAmount,allAllocations:Lt[G].allAllocations,tokens:Wt,routeInputToken:n,routeOutputToken:r,overallPriceImpact:"0"},jt[G].pool.x=jt[G].pool.supplies[Lt[G].inputToken],jt[G].pool.y=jt[G].pool.supplies[Lt[G].outputToken],t.next=116;break;case 139:return t.next=141,bt(jt);case 141:for(G in Ut=t.sent,jt)(qt=jt[G]).overallPriceImpact=Ut,qt.outputToken===r&&qt.inputToken!=n&&(qt.pool.partialAmountIn="0");return t.abrupt("return",jt);case 144:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()(u));case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function bt(t){return xt.apply(this,arguments)}function xt(){return(xt=j(R().mark((function t(e){var n,r,u,i,a,s,c,l,p,f,d,v,h,m,k,w,g,y,b,x,I,_,S;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.filter((function(t){return t.outputToken==t.routeOutputToken})).map((function(t){return new o(t.estimate)})).reduce((function(t,e){return t.plus(e)}),new o(0)),r=e[0].tokens[0],u=new o(e[0].totalInputAmount).div(new o(10).pow(r.decimals)),i=n.div(u),a=new o(0),s=e[0].allRoutes,c=e[0].allNodeRoutes,l=e[0].allAllocations.map((function(t){return new o(t)})),p=l.map((function(t){return new o(t)})).reduce((function(t,e){return t.plus(e)}),new o(0)),f=l.map((function(t){return t.div(p)})),t.t0=R().keys(s);case 11:if((t.t1=t.t0()).done){t.next=23;break}return v=s[d=t.t1.value],h=c[d],t.next=17,Promise.all(h.map(function(){var t=j(R().mark((function t(e){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,$(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 17:m=t.sent,k=f[d],1==v.length?(w=new o(v[0].reserves[h[0]]).div(new o(10).pow(m[0].decimals)),g=new o(v[0].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),y=w.div(g)):(b=new o(v[0].reserves[h[0]]).div(new o(10).pow(m[0].decimals)),x=new o(v[0].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),I=new o(v[1].reserves[h[1]]).div(new o(10).pow(m[1].decimals)),_=new o(v[1].reserves[h[2]]).div(new o(10).pow(m[2].decimals)),y=b.div(x).times(I).div(_)),a=a.plus(k.times(new o(1).div(y))),t.next=11;break;case 23:return S=a.minus(i).div(i).times(new o(100)).toString(),t.abrupt("return",S);case 25:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function It(t){return function(t){var e=[];for(var n in t)e.push([t[n],n]);return e}(t).sort((function(t,e){return new o(e[0]).minus(new o(t[0]))})).map((function(t){return t[1]}))}function _t(t,e,n,r){void 0===r&&(r=!0);var o=t.filter((function(t){return t.token1Id===e&&t.token2Id===n||t.token1Id===n&&t.token2Id===e}));return r&&(o=o.filter((function(t){return"0"!=t.token1Supply&&"0"!=t.token2Supply}))),o}function St(t,e){void 0===e&&(e=1e-4);for(var n=new o(e),r=function(t){var e=function(t){var e=[];for(var n in t){var r=t[n];r.amounts=[r.token1Supply,r.token2Supply];var u=r.amounts.map((function(t){return new o(t)})),i=u[0].times(u[1]);e.push(i)}return e}(t),n=function(t){if(t.length<1)return null;var e=t[0];for(var n in t){var r=t[n];r.gt(e)&&(e=r)}return e}(e);return e.map((function(t){return t.div(n)}))}(t),u=[],i=0;i<r.length;i++)r[i]>n&&u.push(t[i]);return u}function Ot(t,e){var n=e[0],r=e[1];Object.keys(t).includes(n)?Object.keys(t[n]).includes(r)||(t[n][r]=1):(t[n]={},t[n][r]=1),Object.keys(t).includes(r)?Object.keys(t[r]).includes(n)||(t[r][n]=1):(t[r]={},t[r][n]=1)}function Nt(t,e){var n=JSON.parse(JSON.stringify(t)),r=e[0],o=e[1];return Object.keys(n).includes(r)&&Object.keys(n[r]).includes(o)&&delete n[r][o],Object.keys(n).includes(o)&&Object.keys(n[o]).includes(r)&&delete n[o][r],n}function Tt(t,e){var n=JSON.parse(JSON.stringify(t));Object.keys(n).includes(e)&&delete n[e];var r=Object.keys(n);for(var o in r){var u=r[o];Object.keys(n[u]).includes(e)&&delete n[u][e]}return n}function Pt(t,e,n,r,o){void 0===r&&(r=[]),void 0===o&&(o=[]);var u=JSON.parse(JSON.stringify(t));for(var i in r)u=Tt(u,r[i]);for(var a in o)u=Nt(u,o[a]);var s=function(t,e){var n={};for(n[e]={},n[e].path=[],n[e].dist=0;;){var r=null,o=null,u=Infinity;for(var i in n)if(n[i]||(n[i]={}),n[i].path){var a=n[i].dist,s=t[i];for(var c in s)if(n[c]||(n[c]={}),!n[c].path){var l=s[c]+a;l<u&&(r=n[i].path,o=c,u=l)}}if(Infinity===u)break;n[o].path=r.concat(o),n[o].dist=u}return n}(u,e)[n];return s.path.unshift(e),s}o.RM=0,o.DP=40,o.NE=-40,o.PE=40;var Et=function(){function t(){this.paths=[],this.sortedpaths=[]}var e=t.prototype;return e.len=function(){return this.sortedpaths.length},e.push=function(t,e){e&&!Rt(this.paths,e)&&(this.sortedpaths.push([t,e]),this.sortedpaths.sort((function(t,e){return t[0]-e[0]})),this.paths.push(e))},e.pop=function(){var t=this.sortedpaths.shift()[1];return this.paths.splice(this.paths.indexOf(t),1),t},t}();function At(t,e){return Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((function(t,n){return t===e[n]}))}function Rt(t,e){var n=JSON.stringify(e);for(var r in t)if(JSON.stringify(t[r])==n)return!0;return!1}function Lt(t,e,n){var r,o,u,i,a,s,c,l,p,f,d,v,h,m,k,w;return R().wrap((function(g){for(;;)switch(g.prev=g.next){case 0:r=[],o=new Et,u=null;case 3:if(u)for(a=[],s=[],c=1;c<u.length;c++){for(f in l=u.slice(0,c),p=l.length,r)At((d=r[f]).slice(0,c),l)&&s.push([d[c-1],d[c]]);try{v=Pt(t,l[l.length-1],n,a=a,s=s),h=v.dist,m=v.path,k=l.slice(0,l.length-1).concat(m),o.push(p+h,k)}catch(t){}a.push(l[l.length-1])}else i=Pt(t,e,n),o.push(i.dist,i.path);if(!o.sortedpaths){g.next=19;break}return g.prev=6,w=o.pop(),g.next=10,w;case 10:r.push(w),u=w,g.next=17;break;case 14:return g.prev=14,g.t0=g.catch(6),g.abrupt("break",22);case 17:g.next=20;break;case 19:return g.abrupt("break",22);case 20:g.next=3;break;case 22:case"end":return g.stop()}}),rt,null,[[6,14]])}function jt(t,e,n,r,o){return void 0===o&&(o=3),function(o){var u=[];o<2&&(o=2);for(var i=Lt(t,e,n),a=1;a<=r;a++)try{var s=i.next().value;if(s&&!Rt(u,s)){if(s.length>o)break;u.push(s)}}catch(t){break}return u}(o)}function Dt(t,e,n,r){return Ft.apply(this,arguments)}function Ft(){return(Ft=j(R().mark((function t(e,n,r,o){var u;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===o&&(o=3),u=Mt(e),t.abrupt("return",jt(u,n,r,100,o));case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Mt(t){var e={};return function(t,e){for(var n in e)Ot(t,e[n])}(e,t.filter((function(t){return"0"!=t.token1Supply&&"0"!=t.token2Supply})).map((function(t){return[t.token1Id,t.token2Id]}))),e}function Ct(t,e,n,r,o){return Bt.apply(this,arguments)}function Bt(){return(Bt=j(R().mark((function t(e,n,r,o,u){return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,gt(e,n,r,o,u);case 2:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Gt(t,e){return t.filter((function(t){return t.outputToken===e})).map((function(t){return new o(t.estimate)})).reduce((function(t,e){return t.plus(e)}),new o(0))}var Wt=function(t){var e=t.tokenIn,n=t.tokenOut,r=t.pool,u=Number(t.amountIn)*(1e4-r.fee),i=N(e.decimals,r.supplies[e.id]),a=N(n.decimals,r.supplies[n.id]);return{token:e,estimate:new o((u*Number(a)/(1e4*Number(i)+u)).toString()).toFixed(),pool:r,outputToken:n.id,inputToken:e.id}},Ut=function(t){var e=t.tokenIn,n=t.tokenOut,r=t.amountIn,o=t.stablePool,u=b(o),i=et(e.id,n.id,r,o,u),a=i[0],s=i[2],c=a<0||isNaN(a)?"0":A(P(a.toString()),0),l=a<0||isNaN(a)||isNaN(s)?"0":A(P(s.toString()),0);return{estimate:N(u,c),noFeeAmountOut:N(u,l),pool:o,token:e,outputToken:n.id,inputToken:e.id}},qt=function(t){var e=t.tokenIn,n=t.tokenOut,r=t.simplePools,o=t.amountIn,i=t.stablePools;if(!r||0===r.length)throw d;var a=r.filter((function(t){return t.tokenIds.includes(e.id)&&t.tokenIds.includes(n.id)})).map((function(t){return Wt({tokenIn:e,tokenOut:n,pool:t,amountIn:o})})),s=null==i?void 0:i.filter((function(t){return t.token_account_ids.includes(e.id)&&t.token_account_ids.includes(n.id)})),c=null==s?void 0:s.map((function(t){return Ut({tokenIn:e,tokenOut:n,amountIn:o,stablePool:t})})),l=1===a.length?a[0]:u.maxBy(a,(function(t){return Number(t.estimate)}));if(!c)return l;var p=1===c.length?c[0]:u.maxBy(c,(function(t){return Number(t.estimate)}));return Number(null==l?void 0:l.estimate)>Number(null==p?void 0:p.estimate)?l:p},Jt=function(t){var e=t.tokenInId,n=t.tokenOutId;return t.stablePools.filter((function(t){return t.tokenIds.includes(e)&&t.tokenIds.includes(n)&&e!==n}))},$t=function(t){var e=t.tokenInId,n=t.tokenOutId;return e===n?[]:t.pools.filter((function(t){return t.tokenIds.includes(e)&&t.tokenIds.includes(n)}))},Kt=function(){var t=j(R().mark((function t(e){var n,r,o,u,i;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.tokenIn,r=e.tokenOut,o=e.amountIn,i=e.pool,!(u=e.stablePoolDetail)){t.next=5;break}return t.abrupt("return",Ut({tokenIn:n,tokenOut:r,stablePool:u,amountIn:o}));case 5:return t.abrupt("return",Wt({tokenIn:n,tokenOut:r,pool:i,amountIn:o}));case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();function Vt(t,e,n,r,o,u){return Yt.apply(this,arguments)}function Yt(){return(Yt=j(R().mark((function t(e,n,r,i,a,s){var c,l,p,f,d,v,h,m,k,w,b,x,I,_,S,O,P,E,A,L,j,F,C,B,G,W,U,q,J,V,Y,H,Z,z,Q,X,tt,et,nt,rt,ot,ut,it,at,st;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(g(a,e.id)||g(a,n.id)){t.next=2;break}return t.abrupt("return",{actions:[],estimate:"0"});case 2:if(c=a.reduce((function(t,e){var n;return D({},t,((n={})[e.id]=e,n))}),{}),l=T(e.decimals,r),d=[],v=[],h=[],m=[],k=[],g(a,e.id))for(d=i.filter((function(t){return t.tokenIds.includes(e.id)})),w=d.map((function(t){return t.tokenIds.filter((function(t){return t!==e.id}))})).flat(),b=M(w);!(x=b()).done;)_=Jt({tokenInId:I=x.value,tokenOutId:n.id,stablePools:i}),S=$t({tokenInId:I,tokenOutId:n.id,pools:s}),O=S.concat(_),v.push.apply(v,O.filter((function(t){var e=Object.values(t.supplies);return new o(e[0]).times(new o(e[1])).gt(0)})));if(g(a,n.id))for(m=i.filter((function(t){return t.tokenIds.includes(n.id)})),P=m.map((function(t){return t.tokenIds.filter((function(t){return t!==n.id}))})).flat(),E=M(P);!(A=E()).done;)j=Jt({tokenInId:e.id,tokenOutId:L=A.value,stablePools:i}),F=$t({tokenInId:e.id,tokenOutId:L,pools:s}),C=F.concat(j),h.push.apply(h,C.filter((function(t){var e=Object.values(t.supplies);return new o(e[0]).times(new o(e[1])).gt(0)})));for(B=M(d);!(G=B()).done;)for(U=(W=G.value).tokenIds.filter((function(t){return t!==e.id})),q=function(){var t=V.value,e=v.filter((function(e){return e.tokenIds.includes(t)&&e.tokenIds.includes(n.id)&&t!==n.id})),r=u.maxBy(e,(function(t){return Number(new o(N(n.decimals,t.supplies[n.id])))}));t===n.id&&(r=W),W&&r&&k.push(W.id===r.id?[W]:[W,r])},J=M(U);!(V=J()).done;)q();for(Y=0,H=h;Y<H.length;Y++)for(z=(Z=H[Y]).tokenIds.filter((function(t){return t!==e.id})),Q=function(){var t=tt.value,e=m.filter((function(e){return e.tokenIds.includes(t)&&e.tokenIds.includes(n.id)&&t!==n.id})),r=u.maxBy(e,(function(t){return Number(new o(N(n.decimals,t.supplies[n.id])))}));t===n.id&&(r=Z),Z&&r&&k.push(Z.id===r.id?[Z]:[Z,r])},X=M(z);!(tt=X()).done;)Q();if(!(k.length>0)){t.next=36;break}return t.next=16,K(k.map((function(t){return t.map((function(t){return t.tokenIds})).flat()})).flat());case 16:if(et=t.sent,nt=1===k.length?k[0]:u.maxBy(k,(function(t){if(1===t.length){if(y(a,t[0].id)){var o=Jt({tokenInId:e.id,tokenOutId:n.id,stablePools:i})[0],u=a.find((function(t){return t.id===o.id}));return Number(Ut({tokenIn:e,tokenOut:n,stablePool:u,amountIn:r}).estimate)}return Number(Wt({tokenIn:e,tokenOut:n,amountIn:r,pool:t[0]}).estimate)}var s=t[0],l=t[1],p=t[0].tokenIds.find((function(e){return t[1].tokenIds.includes(e)})),f=et[p],d=D({},y(a,s.id)?Ut({tokenIn:e,tokenOut:f,amountIn:r,stablePool:c[s.id]}):Wt({tokenIn:e,tokenOut:f,amountIn:r,pool:s})),v=D({},y(a,l.id)?Ut({tokenIn:f,tokenOut:n,amountIn:d.estimate,stablePool:c[l.id]}):Wt({tokenIn:f,tokenOut:n,pool:l,amountIn:d.estimate}));return Number(v.estimate)}))){t.next=20;break}return t.abrupt("return",{actions:[],estimate:"0"});case 20:if(1!==nt.length){t.next=26;break}return rt=nt[0],t.next=24,Kt({tokenIn:e,tokenOut:n,amountIn:r,pool:rt,stablePoolDetail:c[rt.id]});case 24:return t.abrupt("return",{actions:[D({},ot=t.sent,{pool:D({},rt,{parsedAmountIn:l}),tokens:[e,n],inputToken:e.id,outputToken:n.id,totalInputAmount:T(e.decimals,r)})],estimate:ot.estimate});case 26:return p=nt[0],f=nt[1],ut=nt[0].tokenIds.find((function(t){return nt[1].tokenIds.includes(t)})),t.next=31,$(ut);case 31:return it=t.sent,(at=D({},y(a,p.id)?Ut({tokenIn:e,tokenOut:it,amountIn:r,stablePool:c[p.id]}):Wt({tokenIn:e,tokenOut:it,amountIn:r,pool:p}),{tokens:[e,it,n],inputToken:e.id,outputToken:it.id})).pool.partialAmountIn=l,st=D({},y(a,f.id)?Ut({tokenIn:it,tokenOut:n,amountIn:at.estimate,stablePool:c[f.id]}):Wt({tokenIn:it,tokenOut:n,amountIn:at.estimate,pool:f}),{tokens:[e,it,n],inputToken:it.id,outputToken:n.id}),t.abrupt("return",{actions:[at,st],estimate:st.estimate});case 36:return t.abrupt("return",{actions:[],estimate:"0"});case 37:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Ht=function(){var t=j(R().mark((function t(e){var n,r,u,i,a,s,c,l,v,h,m,k,g,y,b,x;return R().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u=e.amountIn,i=e.simplePools,a=e.options,(n=e.tokenIn).id!==(r=e.tokenOut).id){t.next=3;break}throw p;case 3:if(!O.test(u)){t.next=5;break}throw f;case 5:if(c=(s=a||{}).enableSmartRouting,l=s.stablePools,v=s.stablePoolsDetail,h=T(n.decimals,u),c){t.next=12;break}return m=qt({tokenIn:n,tokenOut:r,simplePools:i,amountIn:u,stablePools:v}),t.abrupt("return",[D({},m,{pool:D({},null==m?void 0:m.pool,{partialAmountIn:h})})]);case 12:return k=i.map((function(t){return w(t)})),t.next=15,Ct(k,n.id,r.id,h);case 15:return y=Gt(g=t.sent,r.id).toString(),t.next=19,Vt(n,r,u,l||[],v||[],i);case 19:if(x=(b=t.sent).estimate.toString(),!new o(y||"0").gte(x||"0")){t.next=27;break}if(null!=g&&g.length){t.next=24;break}throw d;case 24:return t.abrupt("return",g);case 27:return t.abrupt("return",b.actions);case 28:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Zt=new e.providers.JsonRpcProvider({url:i().nodeUrl});exports.DEFAULT_PAGE_LIMIT=100,exports.FEE_DIVISOR=1e4,exports.NoPoolError=d,exports.NotLoginError=v,exports.ONE_YOCTO_NEAR="0.000000000000000000000001",exports.ONLY_ZEROS=O,exports.RATED_POOL_LP_TOKEN_DECIMALS=24,exports.REF_FI_CONTRACT_ID=s,exports.STABLE_LP_TOKEN_DECIMALS=18,exports.STORAGE_TO_REGISTER_WITH_MFT="0.1",exports.SameInputTokenError=p,exports.SwapRouteError=h,exports.TokenNotExistError=m,exports.ZeroInputError=f,exports.calc_d=Q,exports.calc_swap=tt,exports.calc_y=X,exports.config=a,exports.convertToPercentDecimal=I,exports.estimateSwap=Ht,exports.fetchAllRefPools=z,exports.formatError=c,exports.formatWithCommas=E,exports.ftGetStorageBalance=function(t,e){return void 0===e&&(e=W.getAccountId()),q(t,{methodName:"storage_balance_of",args:{account_id:e}})},exports.ftGetTokenMetadata=$,exports.ftGetTokensMetadata=K,exports.ftViewFunction=q,exports.getAmount=function(t){return new n(t&&e.utils.format.parseNearAmount(t)||"0")},exports.getConfig=i,exports.getGas=function(t){return new n(t||"100000000000000")},exports.getHybridStableSmart=Vt,exports.getMemorySigner=function(t){var n=require("os").homedir(),r=require("path").join(n,".near-credentials"),o=new e.keyStores.UnencryptedFileSystemKeyStore(r),u=new e.InMemorySigner(o);console.log(u)},exports.getPoolEstimate=Kt,exports.getPoolsByTokens=$t,exports.getRatedPoolDetail=V,exports.getRefPools=Z,exports.getSimplePoolEstimate=Wt,exports.getStablePoolDecimal=b,exports.getStablePoolEstimate=Ut,exports.getStablePoolsDetail=H,exports.getStablePoolsThisPair=Jt,exports.getSwappedAmount=et,exports.getTotalPools=J,exports.getUnRatedPoolDetail=Y,exports.instantSwap=C,exports.isStablePool=y,exports.isStablePoolToken=g,exports.keyStore=B,exports.near=G,exports.parsePool=k,exports.percentLess=S,exports.percentOf=_,exports.poolFormatter=w,exports.provider=Zt,exports.refFiViewFunction=U,exports.round=x,exports.scientificNotationToString=P,exports.singlePoolSwap=qt,exports.toNonDivisibleNumber=T,exports.toPrecision=A,exports.toReadableNumber=N,exports.unNamedError=l,exports.wallet=W;
//# sourceMappingURL=ref-sdk.cjs.production.min.js.map
