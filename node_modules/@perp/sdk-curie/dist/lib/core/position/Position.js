"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../internal/Channel.js"),t=require("../../internal/ChannelEventSource.js");require("../../constants/envVariables.js"),require("../../constants/numbers.js");var i=require("big.js");require("ethers");var s=require("../clearingHouse/utils.js"),a=require("./types.js");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r,o=n(i);exports.PositionType=void 0,(r=exports.PositionType||(exports.PositionType={})).TAKER="TAKER",r.MAKER="MAKER";class c extends e.Channel{constructor({perp:e,market:t,side:i,sizeAbs:s,openNotionalAbs:a,entryPrice:n,liquidationPrice:r,type:o},c){super(c),this._cache=new Map,this._perp=e,this.market=t,this.side=i,this.sizeAbs=s,this.openNotionalAbs=a,this.entryPrice=n,this.liquidationPrice=r,this.type=o}get sizeOriginal(){return this.sizeAbs.mul(this.side===a.PositionSide.LONG?1:-1)}get openNotionalOriginal(){return this.openNotionalAbs.mul(this.side===a.PositionSide.LONG?-1:1)}get isBaseToQuote(){return this.side===a.PositionSide.LONG}get isExactInput(){return this.side===a.PositionSide.LONG}async getSwap({cache:e=!0}={}){return this._fetch("swap",{cache:e})}async getExitPrice({cache:e=!0}={}){const{exchangedPositionSize:t,exchangedPositionNotional:i}=await this._fetch("swap",{cache:e});return s.getSwapRate({amountBase:t,amountQuote:i})}async getPriceImpact({cache:e=!0}={}){const t=await this.getExitPrice({cache:e}),{markPrice:i}=await this.market.getPrices({cache:e});return s.getPriceImpact({price:t,markPrice:i})}async getUnrealizedPnl({cache:e=!0}={}){const{deltaAvailableQuote:t}=await this._fetch("swap",{cache:e}),i=this.side===a.PositionSide.LONG;return s.getUnrealizedPnl({isLong:i,deltaAvailableQuote:t,openNotionalAbs:this.openNotionalAbs})}async getTransactionFee({cache:e=!0}={}){const{deltaAvailableQuote:t,exchangedPositionNotional:i}=await this._fetch("swap",{cache:e}),a=this._perp.clearingHouseConfig.marketExchangeFeeRatios[this.market.baseAddress];return s.getTransactionFee({isBaseToQuote:this.isBaseToQuote,exchangedPositionNotional:i,deltaAvailableQuote:t,feeRatio:a})}async _handleMarketUpdate(){try{await this._fetch("swap",{cache:!1}),this.emit("updated",this)}catch(e){this.emit("updateError",e)}}_getEventSourceMap(){return{updated:new t.ChannelEventSource({eventSourceStarter:()=>this.market.on("updated",this._handleMarketUpdate.bind(this)),initEventEmitter:e=>{"updated"===e&&this.emit("updated",this)}})}}async getOppositeAmountBound(e){const{output:t}=await this._fetch("swap",{cache:!1});let i;return this.isExactInput?i=t.mul(new o.default(1).sub(e)):(i=t.mul(new o.default(1).add(e)),e.eq(0)&&!this.isBaseToQuote&&(i=i.add(new o.default(1).mul(1e-18)))),i}static same(e,t){return e.market.tickerSymbol===t.market.tickerSymbol&&e.side===t.side&&e.sizeAbs.eq(t.sizeAbs)}async _fetch(e,{cache:t=!0}={}){if(this._cache.has(e)&&t)return this._cache.get(e);let i;if("swap"===e)i=await this._perp.contractReader.getQuoterSwap({baseTokenAddress:this.market.baseAddress,amount:this.sizeAbs,isBaseToQuote:this.isBaseToQuote,isExactInput:this.isExactInput});return this._cache.set(e,i),i}}exports.Position=c;
//# sourceMappingURL=Position.js.map
