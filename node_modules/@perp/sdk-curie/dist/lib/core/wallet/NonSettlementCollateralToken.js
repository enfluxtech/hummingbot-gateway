"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("ethers"),t=require("../../contracts/Contracts.js"),a=require("../../internal/Channel.js"),r=require("../../internal/ChannelEventSource.js"),c=require("../../utils/formatters.js"),n=require("../../transactionSender/index.js");require("big.js"),require("../../utils/tick.js"),require("../../constants/envVariables.js"),require("../../constants/numbers.js");class s extends a.Channel{constructor(e,t,a){super(e.channelRegistry),this._perp=e,this._cache=new Map,this._contract=t,this._priceFeedContract=a,this._contractReader=e.contractReader,this._metadataInfo=e.metadata.findCollateralByAddress(t.address)}get contract(){return this._contract}get priceFeedContract(){return this._priceFeedContract}get address(){return this._contract.address}async symbol({cache:e=!0}={}){return this._fetch("symbol",{cache:e})}async name({cache:e=!0}={}){return this._fetch("name",{cache:e})}async decimals({cache:e=!0}={}){return this._fetch("decimals",{cache:e})}async weight({cache:e=!0}={}){return this._fetch("weight",{cache:e})}async cap({cache:e=!0}={}){return this._fetch("cap",{cache:e})}async price({cache:e=!0}={}){return this._fetch("price",{cache:e})}async balanceOf(e){const t=await this.decimals();return this._contractReader.getBalanceByToken(e,this.address,t)}async allowance(e,t){return this._contractReader.getAllowanceByToken(e,t,this.address)}async approve(a,r,s){const i=await this.decimals();return n.getTransaction({account:a,contract:this._contract,contractName:t.ContractName.COLLATERAL_TOKENS,contractFunctionName:"approve",args:[r,s?c.big2BigNumberAndScaleUp(s,i):e.constants.MaxUint256]})}_getEventSourceMap(){return{Approval:new r.ChannelEventSource({eventSourceStarter:e=>{const t=(...e)=>this.emit("Approval",...e);return this._contract.on("Approval",t),()=>this._contract.off("Approval",t)}}),Transfer:new r.ChannelEventSource({eventSourceStarter:e=>{const t=(...e)=>this.emit("Transfer",...e);return this._contract.on("Transfer",t),()=>this._contract.off("Transfer",t)}})}}async _fetch(e,{cache:t=!0}={}){var a,r,n;if(this._cache.has(e)&&t)return this._cache.get(e);let s;switch(e){case"symbol":{const e=null===(a=this._metadataInfo)||void 0===a?void 0:a.symbol;s=e||await this._contract.symbol();break}case"name":{const e=null===(r=this._metadataInfo)||void 0===r?void 0:r.name;s=e||await this._contract.name();break}case"decimals":{const e=null===(n=this._metadataInfo)||void 0===n?void 0:n.decimals;s=e||await this._contract.decimals();break}case"weight":s=(await this._contractReader.getCollateralConfig(this.address)).collateralRatio;break;case"cap":s=(await this._contractReader.getCollateralConfig(this.address)).depositCap;break;case"price":{const[e,t]=await Promise.all([this._priceFeedContract.getPrice(0),this._priceFeedContract.decimals()]);s=c.bigNumber2BigAndScaleDown(e,t).toNumber();break}}return this._cache.set(e,s),s}}exports.NonSettlementCollateralToken=s;
//# sourceMappingURL=NonSettlementCollateralToken.js.map
